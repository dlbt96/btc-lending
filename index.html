<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>‚Çø Collateral Protocol ‚Äî Multiplayer</title>

<!-- Firebase compat SDK (v9 compat layer = works with plain firebase.xxx calls) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&display=swap');

:root {
  --bg: #060a0f;
  --surface: #0d1520;
  --surface2: #111e2e;
  --border: #1a2d42;
  --border2: #243d58;
  --gold: #f5c842;
  --gold2: #e8a800;
  --green: #00d68f;
  --red: #ff3b5c;
  --blue: #3d9bff;
  --orange: #ff7a3d;
  --text: #e8eef5;
  --muted: #4a6080;
  --muted2: #6b8aaa;
  --font: 'Syne', sans-serif;
  --mono: 'DM Mono', monospace;
}

* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; background: var(--bg); color: var(--text); font-family: var(--font); overflow-x: hidden; }

/* scrollbar */
::-webkit-scrollbar { width: 3px; height: 3px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
#app { min-height: 100vh; display: flex; flex-direction: column; }

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.screen { display: none; flex-direction: column; min-height: 100vh; padding: 24px; max-width: 1200px; margin: 0 auto; width: 100%; }
.screen.active { display: flex; }

/* ‚îÄ‚îÄ TYPOGRAPHY ‚îÄ‚îÄ */
h1 { font-size: clamp(28px, 5vw, 52px); font-weight: 800; letter-spacing: -1px; line-height: 1; }
h2 { font-size: clamp(18px, 3vw, 26px); font-weight: 700; }
h3 { font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; color: var(--muted2); }
.mono { font-family: var(--mono); }

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 20px;
  position: relative;
  overflow: hidden;
}
.card::before {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(135deg, rgba(61,155,255,0.03) 0%, transparent 60%);
  pointer-events: none;
}
.card-sm { padding: 14px; border-radius: 12px; }

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn {
  font-family: var(--font);
  font-weight: 700;
  font-size: 13px;
  letter-spacing: 0.5px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  padding: 12px 22px;
  transition: all 0.18s;
  white-space: nowrap;
}
.btn:hover { transform: translateY(-1px); filter: brightness(1.12); }
.btn:active { transform: translateY(0); filter: brightness(0.95); }
.btn:disabled { opacity: 0.35; cursor: not-allowed; transform: none; filter: none; }

.btn-gold { background: var(--gold); color: #0a0a0a; }
.btn-green { background: var(--green); color: #0a0a0a; }
.btn-red { background: var(--red); color: #fff; }
.btn-blue { background: var(--blue); color: #fff; }
.btn-ghost { background: transparent; color: var(--muted2); border: 1px solid var(--border2); }
.btn-ghost:hover { background: var(--surface2); color: var(--text); }
.btn-surface { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
.btn-lg { padding: 16px 32px; font-size: 16px; border-radius: 14px; }
.btn-sm { padding: 7px 14px; font-size: 11px; border-radius: 7px; }
.btn-full { width: 100%; }

/* ‚îÄ‚îÄ INPUTS ‚îÄ‚îÄ */
.inp {
  background: var(--bg);
  border: 1px solid var(--border2);
  border-radius: 10px;
  padding: 12px 16px;
  color: var(--text);
  font-family: var(--mono);
  font-size: 15px;
  outline: none;
  width: 100%;
  transition: border-color 0.2s;
}
.inp:focus { border-color: var(--gold); }
.inp::placeholder { color: var(--muted); }

/* ‚îÄ‚îÄ BADGE ‚îÄ‚îÄ */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 1px;
  text-transform: uppercase;
  padding: 4px 10px;
  border-radius: 20px;
}
.badge-lender { background: rgba(0,214,143,0.15); color: var(--green); border: 1px solid rgba(0,214,143,0.3); }
.badge-borrower { background: rgba(245,200,66,0.15); color: var(--gold); border: 1px solid rgba(245,200,66,0.3); }
.badge-teacher { background: rgba(61,155,255,0.15); color: var(--blue); border: 1px solid rgba(61,155,255,0.3); }

/* ‚îÄ‚îÄ TAG ‚îÄ‚îÄ */
.tag { font-family: var(--mono); font-size: 10px; color: var(--muted2); background: var(--surface2); border: 1px solid var(--border); border-radius: 5px; padding: 2px 7px; }

/* ‚îÄ‚îÄ PILL TABS ‚îÄ‚îÄ */
.tabs { display: flex; gap: 6px; background: var(--surface2); border-radius: 12px; padding: 5px; }
.tab { flex: 1; text-align: center; padding: 8px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 700; color: var(--muted2); transition: all 0.2s; border: none; background: transparent; font-family: var(--font); }
.tab.active { background: var(--surface); color: var(--text); box-shadow: 0 2px 8px rgba(0,0,0,0.4); }

/* ‚îÄ‚îÄ DIVIDER ‚îÄ‚îÄ */
.divider { height: 1px; background: var(--border); margin: 16px 0; }

/* ‚îÄ‚îÄ GRID ‚îÄ‚îÄ */
.grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.grid3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }

/* ‚îÄ‚îÄ STAT ‚îÄ‚îÄ */
.stat { display: flex; flex-direction: column; gap: 3px; }
.stat-label { font-size: 10px; font-weight: 600; letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted); }
.stat-value { font-family: var(--mono); font-size: 22px; font-weight: 500; }
.stat-sub { font-family: var(--mono); font-size: 11px; color: var(--muted2); }

/* ‚îÄ‚îÄ PRICE BAR ‚îÄ‚îÄ */
.price-up { color: var(--green); }
.price-down { color: var(--red); }

/* ‚îÄ‚îÄ HEALTH BAR ‚îÄ‚îÄ */
.hbar { height: 4px; border-radius: 2px; background: var(--border); overflow: hidden; margin-top: 4px; }
.hbar-fill { height: 100%; border-radius: 2px; transition: width 0.5s; }

/* ‚îÄ‚îÄ LOAN CARD ‚îÄ‚îÄ */
.loan-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 12px; padding: 14px; margin-bottom: 10px; }
.loan-card.urgent { border-color: var(--red); background: rgba(255,59,92,0.05); }
.loan-card.warning { border-color: var(--gold); background: rgba(245,200,66,0.05); }

/* ‚îÄ‚îÄ OFFER CARD ‚îÄ‚îÄ */
.offer-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 12px; padding: 14px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; }
.offer-card:hover { border-color: var(--border2); transform: translateY(-1px); box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
.offer-card.selected { border-color: var(--gold); background: rgba(245,200,66,0.07); }

/* ‚îÄ‚îÄ MINI CHART ‚îÄ‚îÄ */
canvas.minichart { display: block; }

/* ‚îÄ‚îÄ LOG ‚îÄ‚îÄ */
.log-entry { font-family: var(--mono); font-size: 11px; padding: 5px 0; border-bottom: 1px solid rgba(26,45,66,0.5); line-height: 1.5; }
.log-entry:last-child { border-bottom: none; }
.log-up { color: var(--green); }
.log-down { color: var(--red); }
.log-warn { color: var(--orange); }
.log-info { color: var(--muted2); }
.log-gold { color: var(--gold); }

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.75); display: flex; align-items: center; justify-content: center; z-index: 200; backdrop-filter: blur(4px); }
.modal { background: var(--surface); border: 1px solid var(--border2); border-radius: 20px; padding: 28px; width: 440px; max-width: 94vw; }

/* ‚îÄ‚îÄ TICKER ‚îÄ‚îÄ */
.ticker { font-family: var(--mono); background: var(--surface2); border-bottom: 1px solid var(--border); padding: 8px 24px; font-size: 11px; color: var(--muted2); display: flex; gap: 24px; overflow: hidden; }

/* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
@keyframes fadeUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
@keyframes pulse { 0%,100%{opacity:1}50%{opacity:0.5} }
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes slideIn { from { opacity:0; transform:translateX(-10px); } to { opacity:1; transform:translateX(0); } }
.fade-up { animation: fadeUp 0.4s ease forwards; }
.blink { animation: pulse 1.5s infinite; }
.spin { animation: spin 0.8s linear infinite; }

/* ‚îÄ‚îÄ LOBBY ‚îÄ‚îÄ */
.player-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; background: var(--surface2); border-radius: 10px; margin-bottom: 6px; font-size: 13px; }
.dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
.dot-green { background: var(--green); }
.dot-gray { background: var(--muted); }

/* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
.progress-ring { position: relative; display: inline-flex; align-items: center; justify-content: center; }

/* ‚îÄ‚îÄ TEACHER controls ‚îÄ‚îÄ */
.control-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: var(--surface2); border-radius: 10px; margin-bottom: 8px; }

/* ‚îÄ‚îÄ REQUEST CARD (lender sees) ‚îÄ‚îÄ */
.request-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 12px; padding: 14px; margin-bottom: 10px; transition: border-color 0.2s; }
.request-card.pending { border-left: 3px solid var(--gold); }
.request-card.approved { border-left: 3px solid var(--green); }
.request-card.rejected { border-left: 3px solid var(--red); opacity: 0.5; }

/* hero gradient */
.hero-glow { position: relative; }
.hero-glow::after {
  content: '';
  position: absolute;
  top: -60px; left: 50%; transform: translateX(-50%);
  width: 600px; height: 300px;
  background: radial-gradient(ellipse, rgba(245,200,66,0.08) 0%, transparent 70%);
  pointer-events: none;
}

/* role card */
.role-reveal {
  background: var(--surface);
  border: 2px solid var(--border2);
  border-radius: 20px;
  padding: 40px 32px;
  text-align: center;
  animation: fadeUp 0.5s ease;
}
.role-icon { font-size: 64px; margin-bottom: 16px; display: block; }

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media (max-width: 700px) {
  .grid2, .grid3 { grid-template-columns: 1fr; }
  .screen { padding: 14px; }
}
</style>
</head>
<body>
<!-- Loading overlay -->
<div id="loading-overlay" style="position:fixed;inset:0;background:#060a0f;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999">
  <div style="font-size:48px;margin-bottom:16px">‚Çø</div>
  <div style="font-family:'Syne',sans-serif;font-size:22px;font-weight:700;color:#f5c842;margin-bottom:8px">Collateral Protocol</div>
  <div style="width:24px;height:24px;border:2px solid #1a2d42;border-top-color:#f5c842;border-radius:50%;animation:spin 0.8s linear infinite;margin-top:16px"></div>
  <div style="font-family:monospace;font-size:12px;color:#4a6080;margin-top:12px" id="loading-msg">Connecting...</div>
</div>

<div id="app">

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCREEN: JOIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen active" id="screen-join">
  <div style="max-width:440px;margin:auto;padding-top:60px;width:100%">
    <div style="text-align:center;margin-bottom:36px">
      <div style="font-size:40px;margin-bottom:10px">‚Çø</div>
      <h1>Collateral<br>Protocol</h1>
      <p style="color:var(--muted2);margin-top:8px;font-size:13px;font-family:var(--mono)">Multiplayer BTC lending game</p>
    </div>

    <div class="card" style="margin-bottom:12px">
      <h3 style="margin-bottom:14px">Enter your name</h3>
      <input class="inp" id="player-name" placeholder="Your name..." maxlength="20" style="margin-bottom:12px"/>

      <div class="tabs" id="join-tabs" style="margin-bottom:16px">
        <button class="tab active" onclick="setJoinMode('join')" id="tab-join">Join Game</button>
        <button class="tab" onclick="setJoinMode('create')" id="tab-create">Create Game</button>
      </div>

      <div id="join-panel">
        <input class="inp" id="room-code-input" placeholder="Room code (e.g. BTC42)" maxlength="8" style="margin-bottom:12px;text-transform:uppercase;font-size:18px;text-align:center;letter-spacing:4px"/>
        <button class="btn btn-gold btn-full btn-lg" onclick="joinRoom()">Join ‚Üí</button>
      </div>

      <div id="create-panel" style="display:none">
        <div style="display:flex;gap:10px;margin-bottom:12px">
          <button class="btn btn-surface" style="flex:1" onclick="joinAsTeacher()">
            <div>üéì</div>
            <div style="font-size:11px;margin-top:4px">As Teacher</div>
          </button>
          <button class="btn btn-surface" style="flex:1" onclick="createRoom()">
            <div>üéÆ</div>
            <div style="font-size:11px;margin-top:4px">New Game Room</div>
          </button>
        </div>
        <p style="font-size:11px;color:var(--muted);text-align:center;font-family:var(--mono)">Teacher controls game pace & events</p>
      </div>

      <div id="join-error" style="color:var(--red);font-size:12px;margin-top:8px;display:none;text-align:center;font-family:var(--mono)"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCREEN: LOBBY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-lobby">
  <div style="max-width:560px;margin:auto;width:100%">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;padding-top:24px">
      <div>
        <h2>Game Lobby</h2>
        <p style="font-size:12px;color:var(--muted2);font-family:var(--mono);margin-top:3px">Waiting for players...</p>
      </div>
      <div style="text-align:right">
        <div style="font-size:11px;color:var(--muted2);margin-bottom:4px">Room Code</div>
        <div style="font-family:var(--mono);font-size:28px;font-weight:500;color:var(--gold);letter-spacing:4px" id="lobby-room-code">‚Äî‚Äî</div>
      </div>
    </div>

    <div class="card" style="margin-bottom:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
        <h3>Players (<span id="player-count">0</span>)</h3>
        <span class="tag">Share the room code above</span>
      </div>
      <div id="player-list"></div>
    </div>

    <div class="card" style="margin-bottom:16px">
      <h3 style="margin-bottom:12px">Game Settings</h3>
      <div class="grid2" style="gap:10px">
        <div>
          <div style="font-size:11px;color:var(--muted2);margin-bottom:6px;font-family:var(--mono)">Starting BTC per player</div>
          <input class="inp" id="setting-btc" type="number" value="1.5" step="0.5" min="0.5" max="10"/>
        </div>
        <div>
          <div style="font-size:11px;color:var(--muted2);margin-bottom:6px;font-family:var(--mono)">Starting BTC Price</div>
          <input class="inp" id="setting-price" type="number" value="65000" step="1000" min="10000"/>
        </div>
        <div>
          <div style="font-size:11px;color:var(--muted2);margin-bottom:6px;font-family:var(--mono)">Starting Cash (lenders)</div>
          <input class="inp" id="setting-cash" type="number" value="50000" step="5000" min="5000"/>
        </div>
        <div>
          <div style="font-size:11px;color:var(--muted2);margin-bottom:6px;font-family:var(--mono)">Game Duration (days)</div>
          <input class="inp" id="setting-days" type="number" value="30" step="5" min="10" max="90"/>
        </div>
      </div>
    </div>

    <div id="teacher-lobby-controls">
      <button class="btn btn-gold btn-full btn-lg" onclick="startGame()">Start Game ‚Üí</button>
      <p style="text-align:center;font-size:11px;color:var(--muted);margin-top:8px;font-family:var(--mono)">Roles assigned randomly when game starts</p>
    </div>
    <div id="student-lobby-wait" style="display:none">
      <div class="card" style="text-align:center;padding:24px;background:rgba(245,200,66,0.05);border-color:rgba(245,200,66,0.2)">
        <div class="spin" style="width:24px;height:24px;border:2px solid var(--border2);border-top-color:var(--gold);border-radius:50%;margin:0 auto 12px"></div>
        <p style="color:var(--muted2);font-size:13px;font-family:var(--mono)">Waiting for teacher to start...</p>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCREEN: ROLE REVEAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-role">
  <div style="max-width:420px;margin:auto;padding-top:80px;width:100%;text-align:center">
    <div class="role-reveal" id="role-reveal-card">
      <span class="role-icon" id="role-icon">‚Çø</span>
      <h2 id="role-title" style="margin-bottom:8px">Your Role</h2>
      <p id="role-desc" style="color:var(--muted2);font-size:13px;line-height:1.6;font-family:var(--mono);margin-bottom:24px"></p>
      <div id="role-stats" style="background:var(--surface2);border-radius:12px;padding:16px;text-align:left;margin-bottom:24px"></div>
      <button class="btn btn-gold btn-full btn-lg" onclick="enterGame()">Enter the Market ‚Üí</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCREEN: TEACHER DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-teacher">
  <!-- Ticker -->
  <div class="ticker" id="teacher-ticker" style="margin:-24px -24px 20px -24px;padding:8px 24px">
    <span id="ticker-price">BTC: ‚Äî</span>
    <span id="ticker-day">Day: 0</span>
    <span id="ticker-players">Players: 0</span>
    <span id="ticker-loans">Active Loans: 0</span>
    <span id="ticker-volume">Volume: ‚Äî</span>
  </div>

  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:12px">
    <div>
      <h2>Teacher Dashboard</h2>
      <p style="font-size:12px;color:var(--muted2);font-family:var(--mono);margin-top:3px">Room: <span id="teacher-room-code" style="color:var(--gold);letter-spacing:2px">‚Äî‚Äî</span></p>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <span id="teacher-day-badge" class="badge" style="background:rgba(245,200,66,0.15);color:var(--gold);border:1px solid rgba(245,200,66,0.3);font-size:13px">DAY 0</span>
      <button class="btn btn-gold" onclick="advanceDay()">‚è≠ Next Day</button>
      <button class="btn btn-surface btn-sm" onclick="triggerShock('crash')">üí• Price Crash</button>
      <button class="btn btn-surface btn-sm" onclick="triggerShock('pump')">üöÄ Price Pump</button>
    </div>
  </div>

  <div class="grid3" style="margin-bottom:16px">
    <div class="card card-sm">
      <div class="stat">
        <div class="stat-label">BTC Price</div>
        <div class="stat-value" id="t-price" style="color:var(--gold)">‚Äî</div>
        <div class="stat-sub" id="t-price-chg">‚Äî</div>
      </div>
      <canvas class="minichart" id="t-chart" width="200" height="40" style="margin-top:8px"></canvas>
    </div>
    <div class="card card-sm">
      <div class="stat">
        <div class="stat-label">Active Loans</div>
        <div class="stat-value" id="t-loans">‚Äî</div>
        <div class="stat-sub" id="t-loan-vol">Total volume: ‚Äî</div>
      </div>
    </div>
    <div class="card card-sm">
      <div class="stat">
        <div class="stat-label">Defaults / Repaid</div>
        <div class="stat-value" id="t-defaults" style="color:var(--red)">0 <span style="color:var(--muted2);font-size:16px">/ </span><span id="t-repaid" style="color:var(--green)">0</span></div>
        <div class="stat-sub" id="t-risk">System health: ‚Äî</div>
      </div>
    </div>
  </div>

  <div class="grid2">
    <!-- Players -->
    <div class="card" style="max-height:380px;overflow:hidden;display:flex;flex-direction:column">
      <h3 style="margin-bottom:12px">Players</h3>
      <div style="overflow-y:auto;flex:1" id="teacher-player-list"></div>
    </div>
    <!-- Event Log -->
    <div class="card" style="max-height:380px;overflow:hidden;display:flex;flex-direction:column">
      <h3 style="margin-bottom:12px">Event Log</h3>
      <div style="overflow-y:auto;flex:1" id="teacher-log"></div>
    </div>
  </div>

  <!-- All Loans -->
  <div class="card" style="margin-top:16px">
    <h3 style="margin-bottom:12px">All Active Loans</h3>
    <div id="teacher-loans-list" style="font-family:var(--mono);font-size:11px;color:var(--muted2)">No active loans.</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCREEN: LENDER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-lender">
  <div class="ticker" id="lender-ticker" style="margin:-24px -24px 20px -24px;padding:8px 24px">
    <span id="l-ticker-price">BTC: ‚Äî</span>
    <span id="l-ticker-day">Day: 0</span>
    <span id="l-ticker-name">You: ‚Äî</span>
  </div>

  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px">
    <div>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:3px">
        <h2 id="lender-name">Lender</h2>
        <span class="badge badge-lender">Lender</span>
      </div>
      <p style="font-size:12px;color:var(--muted2);font-family:var(--mono)">Set your lending terms and approve loans</p>
    </div>
    <div id="lender-day-badge" class="badge" style="font-size:13px;background:rgba(245,200,66,0.15);color:var(--gold);border:1px solid rgba(245,200,66,0.3)">DAY 0</div>
  </div>

  <div class="grid3" style="margin-bottom:16px">
    <div class="card card-sm">
      <div class="stat-label">Cash Available</div>
      <div class="stat-value mono" id="l-cash" style="color:var(--green)">‚Äî</div>
      <div class="stat-sub" id="l-cash-locked">Locked: ‚Äî</div>
    </div>
    <div class="card card-sm">
      <div class="stat-label">Total Lent Out</div>
      <div class="stat-value mono" id="l-lent">‚Äî</div>
      <div class="stat-sub" id="l-interest-earned">Interest earned: ‚Äî</div>
    </div>
    <div class="card card-sm">
      <div class="stat-label">BTC Price</div>
      <div class="stat-value mono" id="l-price" style="color:var(--gold)">‚Äî</div>
      <canvas class="minichart" id="l-chart" width="180" height="30" style="margin-top:6px"></canvas>
    </div>
  </div>

  <div class="grid2">
    <!-- Offer Settings -->
    <div class="card">
      <h3 style="margin-bottom:14px">My Lending Offer</h3>
      <div style="margin-bottom:12px">
        <div style="font-size:11px;color:var(--muted2);margin-bottom:6px;font-family:var(--mono)">Interest Rate (% APR)</div>
        <input class="inp" id="l-rate" type="number" value="10" min="1" max="50" step="1"/>
      </div>
      <div style="margin-bottom:12px">
        <div style="font-size:11px;color:var(--muted2);margin-bottom:6px;font-family:var(--mono)">Max LTV (%)</div>
        <input class="inp" id="l-ltv" type="number" value="50" min="10" max="90" step="5"/>
      </div>
      <div style="margin-bottom:14px">
        <div style="font-size:11px;color:var(--muted2);margin-bottom:6px;font-family:var(--mono)">Max Loan Size (USD)</div>
        <input class="inp" id="l-maxloan" type="number" value="20000" min="1000" step="1000"/>
      </div>
      <button class="btn btn-green btn-full" onclick="publishOffer()">Publish Offer</button>
      <div id="l-offer-status" style="font-size:11px;color:var(--muted2);text-align:center;margin-top:8px;font-family:var(--mono)"></div>
    </div>

    <!-- Incoming Requests -->
    <div class="card" style="max-height:360px;overflow:hidden;display:flex;flex-direction:column">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <h3>Loan Requests (<span id="l-req-count">0</span>)</h3>
        <span class="tag blink" id="l-req-badge" style="display:none;color:var(--gold)">NEW</span>
      </div>
      <div style="overflow-y:auto;flex:1" id="l-requests-list">
        <p style="font-size:12px;color:var(--muted);text-align:center;padding:20px;font-family:var(--mono)">No requests yet.</p>
      </div>
    </div>
  </div>

  <!-- Active Loans I've made -->
  <div class="card" style="margin-top:16px;max-height:300px;overflow:hidden;display:flex;flex-direction:column">
    <h3 style="margin-bottom:12px">My Active Loans</h3>
    <div style="overflow-y:auto;flex:1" id="l-active-loans">
      <p style="font-size:12px;color:var(--muted);text-align:center;padding:20px;font-family:var(--mono)">No active loans.</p>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCREEN: BORROWER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-borrower">
  <div class="ticker" id="borrower-ticker" style="margin:-24px -24px 20px -24px;padding:8px 24px">
    <span id="b-ticker-price">BTC: ‚Äî</span>
    <span id="b-ticker-day">Day: 0</span>
    <span id="b-ticker-name">You: ‚Äî</span>
  </div>

  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px">
    <div>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:3px">
        <h2 id="borrower-name">Borrower</h2>
        <span class="badge badge-borrower">Borrower</span>
      </div>
      <p style="font-size:12px;color:var(--muted2);font-family:var(--mono)">Use BTC as collateral to borrow USD</p>
    </div>
    <div id="borrower-day-badge" class="badge" style="font-size:13px;background:rgba(245,200,66,0.15);color:var(--gold);border:1px solid rgba(245,200,66,0.3)">DAY 0</div>
  </div>

  <div class="grid3" style="margin-bottom:16px">
    <div class="card card-sm">
      <div class="stat-label">Free BTC</div>
      <div class="stat-value mono" id="b-btc" style="color:var(--gold)">‚Äî</div>
      <div class="stat-sub" id="b-btc-usd">‚âà ‚Äî</div>
    </div>
    <div class="card card-sm">
      <div class="stat-label">Cash (USD)</div>
      <div class="stat-value mono" id="b-cash" style="color:var(--green)">‚Äî</div>
      <div class="stat-sub" id="b-debt">Debt: ‚Äî</div>
    </div>
    <div class="card card-sm">
      <div class="stat-label">Net Worth</div>
      <div class="stat-value mono" id="b-networth">‚Äî</div>
      <canvas class="minichart" id="b-chart" width="180" height="30" style="margin-top:6px"></canvas>
    </div>
  </div>

  <div class="grid2">
    <!-- Lender Offers -->
    <div class="card" style="max-height:380px;overflow:hidden;display:flex;flex-direction:column">
      <h3 style="margin-bottom:12px">Available Offers (<span id="b-offer-count">0</span>)</h3>
      <div style="overflow-y:auto;flex:1" id="b-offers-list">
        <p style="font-size:12px;color:var(--muted);text-align:center;padding:20px;font-family:var(--mono)">No offers available yet.</p>
      </div>
    </div>

    <!-- My Loans -->
    <div class="card" style="max-height:380px;overflow:hidden;display:flex;flex-direction:column">
      <h3 style="margin-bottom:12px">My Loans (<span id="b-loan-count">0</span>)</h3>
      <div style="overflow-y:auto;flex:1" id="b-loans-list">
        <p style="font-size:12px;color:var(--muted);text-align:center;padding:20px;font-family:var(--mono)">No active loans.</p>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BORROW MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-bg" id="borrow-modal" style="display:none">
  <div class="modal">
    <h2 style="margin-bottom:4px">Request Loan</h2>
    <p style="font-size:12px;color:var(--muted2);margin-bottom:20px;font-family:var(--mono)" id="bm-lender-info">From: ‚Äî</p>
    <div style="margin-bottom:14px">
      <div style="font-size:11px;color:var(--muted2);margin-bottom:6px;font-family:var(--mono)">Duration</div>
      <div style="display:flex;gap:6px" id="bm-dur-btns">
        <button class="btn btn-surface btn-sm" onclick="setBorrowDur(7)" data-dur="7">7d</button>
        <button class="btn btn-surface btn-sm" onclick="setBorrowDur(14)" data-dur="14">14d</button>
        <button class="btn btn-surface btn-sm" onclick="setBorrowDur(30)" data-dur="30">30d</button>
        <button class="btn btn-surface btn-sm" onclick="setBorrowDur(60)" data-dur="60">60d</button>
        <button class="btn btn-gold btn-sm" onclick="setBorrowDur(90)" data-dur="90">90d</button>
      </div>
    </div>
    <div style="margin-bottom:14px">
      <div style="font-size:11px;color:var(--muted2);margin-bottom:6px;font-family:var(--mono)">Amount (USD)</div>
      <input class="inp" id="bm-amount" type="number" placeholder="0" oninput="updateBorrowPreview()"/>
      <div style="display:flex;gap:6px;margin-top:6px" id="bm-pct-btns"></div>
    </div>
    <div id="bm-preview" style="background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:16px;font-family:var(--mono);font-size:12px;display:none"></div>
    <div style="display:flex;gap:10px">
      <button class="btn btn-ghost" style="flex:1" onclick="closeBorrowModal()">Cancel</button>
      <button class="btn btn-gold" style="flex:1" onclick="submitBorrowRequest()">Send Request</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê REPAY MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-bg" id="repay-modal" style="display:none">
  <div class="modal">
    <h2 style="margin-bottom:4px">Repay Loan</h2>
    <p style="font-size:12px;color:var(--muted2);margin-bottom:20px;font-family:var(--mono)" id="rm-info">Loan #‚Äî</p>
    <div id="rm-details" style="background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:16px;font-family:var(--mono);font-size:12px"></div>
    <div style="display:flex;gap:10px">
      <button class="btn btn-ghost" style="flex:1" onclick="closeRepayModal()">Cancel</button>
      <button class="btn btn-green" style="flex:1" onclick="confirmRepay()">Repay Now</button>
    </div>
  </div>
</div>

</div><!-- /app -->

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let db = null;
let roomCode = null;
let myId = null;
let myRole = null; // 'teacher' | 'lender' | 'borrower'
let myName = '';
let isTeacher = false;
let joinMode = 'join';
let selectedOffer = null;
let borrowDuration = 30;
let repayLoanId = null;
let priceHistory = [65000];
let borrowerNWHistory = [];
let gameSettings = {};
let gameData = {};
let offersData = {};
let loansData = {};
let playersData = {};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const fUSD = n => new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}).format(n);
const fBTC = n => (+n).toFixed(4) + ' ‚Çø';
const fPct = n => (+n).toFixed(1) + '%';
const uid = () => Math.random().toString(36).substr(2,9);
const roomId = () => {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let r = '';
  for(let i=0;i<5;i++) r += chars[Math.floor(Math.random()*chars.length)];
  return r;
};
function owed(loan, day) {
  const d = Math.max(day - loan.originDay, 1);
  const i = loan.amount * (loan.rate/100) * (d/365);
  return { interest: i, total: loan.amount + i };
}
function el(id) { return document.getElementById(id); }
function show(id) { el(id).style.display = ''; }
function hide(id) { el(id).style.display = 'none'; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE INIT ‚Äî config hardcoded, auto-connects on load
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBcBo3g8z5_SgIGMPtgsfD5SP2ukvTKbx8",
  authDomain: "uplend-6480b.firebaseapp.com",
  databaseURL: "https://uplend-6480b-default-rtdb.firebaseio.com",
  projectId: "uplend-6480b",
  storageBucket: "uplend-6480b.firebasestorage.app",
  messagingSenderId: "747535784160",
  appId: "1:747535784160:web:867d6e406552a488725885"
};

function initFirebase() {
  if (typeof firebase === 'undefined') {
    alert('Firebase failed to load. Check your internet connection and reload the page.');
    return;
  }
  try {
    firebase.initializeApp(FIREBASE_CONFIG);
    db = firebase.database();
    db.ref('.info/connected').once('value').then(() => {
      document.getElementById('loading-overlay').style.display = 'none';
      showScreen('screen-join');
    }).catch(e => {
      document.getElementById('loading-msg').textContent = 'Connection failed: ' + e.message;
      document.getElementById('loading-msg').style.color = '#ff3b5c';
    });
  } catch(e) {
    alert('Firebase error: ' + e.message);
  }
}

// Auto-init on page load
window.addEventListener('load', initFirebase);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCREENS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  el(id).classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// JOIN / CREATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setJoinMode(mode) {
  joinMode = mode;
  el('tab-join').classList.toggle('active', mode==='join');
  el('tab-create').classList.toggle('active', mode==='create');
  el('join-panel').style.display = mode==='join' ? '' : 'none';
  el('create-panel').style.display = mode==='create' ? '' : 'none';
}

function getPlayerName() {
  const n = el('player-name').value.trim();
  if (!n) { showJoinError('Enter your name first.'); return null; }
  return n;
}

function showJoinError(msg) {
  el('join-error').textContent = msg;
  show('join-error');
  setTimeout(() => hide('join-error'), 3000);
}

async function joinRoom() {
  const name = getPlayerName(); if (!name) return;
  const code = el('room-code-input').value.trim().toUpperCase();
  if (!code) { showJoinError('Enter a room code.'); return; }
  const snap = await db.ref(`rooms/${code}`).once('value');
  if (!snap.exists()) { showJoinError('Room not found.'); return; }
  const room = snap.val();
  if (room.status === 'playing') { showJoinError('Game already started.'); return; }
  myName = name; roomCode = code; myId = uid(); isTeacher = false;
  await db.ref(`rooms/${code}/players/${myId}`).set({ name, role: 'pending', online: true, joinedAt: Date.now() });
  listenLobby();
  showScreen('screen-lobby');
  el('lobby-room-code').textContent = code;
  el('student-lobby-wait').style.display = '';
  el('teacher-lobby-controls').style.display = 'none';
}

async function createRoom() {
  const name = getPlayerName(); if (!name) return;
  myName = name; roomCode = roomId(); myId = uid(); isTeacher = false;
  await db.ref(`rooms/${roomCode}`).set({
    status: 'lobby', createdAt: Date.now(),
    settings: { btcPerPlayer:1.5, startPrice:65000, lenderCash:50000, gameDays:30 },
    game: { day:0, price:65000, priceHistory:[65000], totalDefaults:0, totalRepaid:0, log:[] }
  });
  await db.ref(`rooms/${roomCode}/players/${myId}`).set({ name, role: 'pending', online: true, joinedAt: Date.now() });
  listenLobby();
  showScreen('screen-lobby');
  el('lobby-room-code').textContent = roomCode;
  el('teacher-lobby-controls').style.display = 'none';
  el('student-lobby-wait').style.display = '';
}

async function joinAsTeacher() {
  const name = getPlayerName() || 'Teacher'; 
  myName = name; roomCode = roomId(); myId = 'teacher'; isTeacher = true;
  await db.ref(`rooms/${roomCode}`).set({
    status: 'lobby', createdAt: Date.now(),
    settings: { btcPerPlayer:1.5, startPrice:65000, lenderCash:50000, gameDays:30 },
    game: { day:0, price:65000, priceHistory:[65000], totalDefaults:0, totalRepaid:0, log:[] }
  });
  await db.ref(`rooms/${roomCode}/players/teacher`).set({ name, role: 'teacher', online: true, joinedAt: Date.now() });
  listenLobby();
  showScreen('screen-lobby');
  el('lobby-room-code').textContent = roomCode;
  el('teacher-lobby-controls').style.display = '';
  el('student-lobby-wait').style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOBBY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function listenLobby() {
  db.ref(`rooms/${roomCode}/players`).on('value', snap => {
    playersData = snap.val() || {};
    renderLobbyPlayers();
  });
  db.ref(`rooms/${roomCode}/status`).on('value', snap => {
    if (snap.val() === 'playing') {
      loadMyRole();
    }
  });
}

function renderLobbyPlayers() {
  const players = Object.entries(playersData);
  el('player-count').textContent = players.length;
  el('player-list').innerHTML = players.map(([id, p]) => `
    <div class="player-row">
      <div style="display:flex;align-items:center;gap:10px">
        <span class="dot dot-green"></span>
        <span style="font-weight:600">${p.name}</span>
        ${id === myId ? '<span class="tag">You</span>' : ''}
      </div>
      <span class="badge ${p.role==='teacher'?'badge-teacher':p.role==='lender'?'badge-lender':p.role==='borrower'?'badge-borrower':''}">${p.role==='pending'?'Waiting...':p.role}</span>
    </div>
  `).join('');
}

async function startGame() {
  const settings = {
    btcPerPlayer: parseFloat(el('setting-btc').value) || 1.5,
    startPrice: parseFloat(el('setting-price').value) || 65000,
    lenderCash: parseFloat(el('setting-cash').value) || 50000,
    gameDays: parseInt(el('setting-days').value) || 30
  };
  await db.ref(`rooms/${roomCode}/settings`).set(settings);

  // Assign roles
  const players = Object.entries(playersData).filter(([id]) => id !== 'teacher');
  const shuffled = players.sort(() => Math.random() - 0.5);
  const half = Math.ceil(shuffled.length / 2);
  
  const updates = {};
  updates[`rooms/${roomCode}/status`] = 'playing';
  
  shuffled.forEach(([id, p], i) => {
    const role = i < half ? 'lender' : 'borrower';
    updates[`rooms/${roomCode}/players/${id}/role`] = role;
    if (role === 'lender') {
      updates[`rooms/${roomCode}/wallets/${id}`] = {
        cash: settings.lenderCash, btc: 0, role: 'lender', name: p.name,
        totalLent: 0, totalInterest: 0, defaults: 0
      };
    } else {
      updates[`rooms/${roomCode}/wallets/${id}`] = {
        cash: 0, btc: settings.btcPerPlayer, role: 'borrower', name: p.name,
        totalBorrowed: 0, totalRepaid: 0, defaults: 0
      };
    }
  });

  await db.ref().update(updates);
}

async function loadMyRole() {
  const snap = await db.ref(`rooms/${roomCode}/players/${myId}`).once('value');
  const player = snap.val();
  if (!player) return;
  myRole = player.role;

  const settingsSnap = await db.ref(`rooms/${roomCode}/settings`).once('value');
  gameSettings = settingsSnap.val() || {};

  showRoleReveal(myRole);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ROLE REVEAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showRoleReveal(role) {
  showScreen('screen-role');
  if (role === 'teacher') { enterGame(); return; }

  if (role === 'lender') {
    el('role-icon').textContent = 'üè¶';
    el('role-title').textContent = 'You are a Lender';
    el('role-reveal-card').style.borderColor = 'var(--green)';
    el('role-desc').textContent = 'Set your interest rates and LTV limits. Review borrower requests. Earn interest ‚Äî but beware of defaults if BTC crashes.';
    el('role-stats').innerHTML = `
      <div class="grid2">
        <div><div class="stat-label">Starting Cash</div><div style="font-family:var(--mono);color:var(--green)">${fUSD(gameSettings.lenderCash||50000)}</div></div>
        <div><div class="stat-label">Starting BTC</div><div style="font-family:var(--mono);color:var(--gold)">0 ‚Çø</div></div>
      </div>`;
  } else {
    el('role-icon').textContent = 'üìà';
    el('role-title').textContent = 'You are a Borrower';
    el('role-reveal-card').style.borderColor = 'var(--gold)';
    el('role-desc').textContent = 'Use your BTC as collateral. Browse lender offers and request loans. Repay before maturity ‚Äî or face liquidation.';
    el('role-stats').innerHTML = `
      <div class="grid2">
        <div><div class="stat-label">Starting BTC</div><div style="font-family:var(--mono);color:var(--gold)">${fBTC(gameSettings.btcPerPlayer||1.5)}</div></div>
        <div><div class="stat-label">Starting Cash</div><div style="font-family:var(--mono);color:var(--green)">$0</div></div>
      </div>`;
  }
}

function enterGame() {
  if (isTeacher || myRole === 'teacher') {
    showScreen('screen-teacher');
    initTeacherDashboard();
  } else if (myRole === 'lender') {
    showScreen('screen-lender');
    initLenderDashboard();
  } else {
    showScreen('screen-borrower');
    initBorrowerDashboard();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TEACHER DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initTeacherDashboard() {
  el('teacher-room-code').textContent = roomCode;

  db.ref(`rooms/${roomCode}/game`).on('value', snap => {
    gameData = snap.val() || {};
    renderTeacherDashboard();
  });
  db.ref(`rooms/${roomCode}/players`).on('value', snap => {
    playersData = snap.val() || {};
    renderTeacherPlayers();
  });
  db.ref(`rooms/${roomCode}/loans`).on('value', snap => {
    loansData = snap.val() || {};
    renderTeacherLoans();
  });
}

function renderTeacherDashboard() {
  const price = gameData.price || 65000;
  const day = gameData.day || 0;
  const hist = gameData.priceHistory || [price];
  priceHistory = hist;

  el('t-price').textContent = fUSD(price);
  el('teacher-day-badge').textContent = `DAY ${day}`;
  el('ticker-price').textContent = `BTC: ${fUSD(price)}`;
  el('ticker-day').textContent = `Day: ${day}`;

  const prevPrice = hist.length > 1 ? hist[hist.length-2] : price;
  const chgPct = ((price - prevPrice)/prevPrice*100).toFixed(2);
  el('t-price-chg').textContent = `${price >= prevPrice ? '‚ñ≤' : '‚ñº'} ${chgPct}%`;
  el('t-price-chg').style.color = price >= prevPrice ? 'var(--green)' : 'var(--red)';

  const defaults = gameData.totalDefaults || 0;
  const repaid = gameData.totalRepaid || 0;
  el('t-defaults').innerHTML = `${defaults} <span style="color:var(--muted2);font-size:16px">/ </span><span id="t-repaid" style="color:var(--green)">${repaid}</span>`;

  const allLoans = Object.values(loansData).filter(l => l.status === 'active');
  el('t-loans').textContent = allLoans.length;
  const vol = allLoans.reduce((s,l) => s + l.amount, 0);
  el('t-loan-vol').textContent = `Total volume: ${fUSD(vol)}`;
  el('ticker-loans').textContent = `Active Loans: ${allLoans.length}`;
  el('ticker-volume').textContent = `Volume: ${fUSD(vol)}`;

  drawChart('t-chart', hist, 200, 40);

  // Log
  const log = gameData.log || [];
  el('teacher-log').innerHTML = [...log].reverse().slice(0,50).map(e =>
    `<div class="log-entry log-${e.type||'info'}">[Day ${e.day}] ${e.msg}</div>`
  ).join('');
}

function renderTeacherPlayers() {
  const players = Object.entries(playersData);
  el('ticker-players').textContent = `Players: ${players.length}`;
  el('teacher-player-list').innerHTML = players.map(([id, p]) => `
    <div class="player-row" style="margin-bottom:6px">
      <div style="display:flex;align-items:center;gap:8px">
        <span class="dot dot-green"></span>
        <span style="font-size:13px;font-weight:600">${p.name}</span>
      </div>
      <span class="badge ${p.role==='lender'?'badge-lender':p.role==='borrower'?'badge-borrower':'badge-teacher'}">${p.role}</span>
    </div>
  `).join('');
}

function renderTeacherLoans() {
  const loans = Object.entries(loansData);
  if (!loans.length) { el('teacher-loans-list').innerHTML = '<p style="color:var(--muted);text-align:center;padding:10px;font-family:var(--mono);font-size:12px">No active loans.</p>'; return; }
  const day = gameData.day || 0;
  const price = gameData.price || 65000;
  el('teacher-loans-list').innerHTML = loans.filter(([,l])=>l.status==='active').map(([id,l]) => {
    const o = owed(l, day);
    const health = (l.collateralBtc * price) / o.total;
    const hColor = health > 1.5 ? 'var(--green)' : health > 1.1 ? 'var(--gold)' : 'var(--red)';
    return `<div style="display:flex;gap:20px;padding:8px 0;border-bottom:1px solid var(--border);font-size:11px">
      <span style="color:var(--muted2)">Loan #${id.substr(0,6)}</span>
      <span>${l.borrowerName} ‚Üí ${l.lenderName}</span>
      <span>${fUSD(l.amount)}</span>
      <span style="color:${hColor}">Health: ${health.toFixed(2)}x</span>
      <span style="color:var(--muted2)">${Math.max((l.originDay+l.duration)-day,0)}d left</span>
    </div>`;
  }).join('') || '<p style="color:var(--muted);text-align:center;padding:10px;font-family:var(--mono);font-size:12px">No active loans.</p>';
}

async function advanceDay() {
  const snap = await db.ref(`rooms/${roomCode}/game`).once('value');
  const game = snap.val() || {};
  const day = (game.day || 0) + 1;
  const price = simPrice(game.price || 65000);
  const hist = [...(game.priceHistory || [65000]).slice(-60), price];

  // Process all active loans
  const loansSnap = await db.ref(`rooms/${roomCode}/loans`).once('value');
  const loans = loansSnap.val() || {};
  const walletsSnap = await db.ref(`rooms/${roomCode}/wallets`).once('value');
  const wallets = walletsSnap.val() || {};

  let updates = {};
  let newLog = [];
  let totalDefaults = game.totalDefaults || 0;
  let totalRepaid = game.totalRepaid || 0;

  for (const [lid, loan] of Object.entries(loans)) {
    if (loan.status !== 'active') continue;
    const matDay = loan.originDay + loan.duration;
    const borrowerWallet = wallets[loan.borrowerId] || {};
    const lenderWallet = wallets[loan.lenderId] || {};
    const o = owed(loan, day);

    // Check LTV breach
    const curLTV = loan.amount / (loan.collateralBtc * price);
    if (curLTV > (loan.ltvLimit || 0.9)) {
      // liquidate
      updates[`rooms/${roomCode}/loans/${lid}/status`] = 'liquidated';
      updates[`rooms/${roomCode}/wallets/${loan.lenderId}/cash`] = (lenderWallet.cash || 0) + loan.collateralBtc * price;
      updates[`rooms/${roomCode}/wallets/${loan.lenderId}/totalInterest`] = (lenderWallet.totalInterest||0) + (loan.collateralBtc*price - loan.amount);
      updates[`rooms/${roomCode}/wallets/${loan.borrowerId}/btc`] = Math.max((borrowerWallet.btc||0), 0);
      totalDefaults++;
      newLog.push({ day, msg: `LIQUIDATED: ${loan.borrowerName}'s loan (${fUSD(loan.amount)}) ‚Äî LTV breached`, type:'down' });
      continue;
    }

    // Check maturity
    if (day >= matDay) {
      if ((borrowerWallet.cash || 0) >= o.total) {
        // auto-repay
        updates[`rooms/${roomCode}/loans/${lid}/status`] = 'repaid';
        updates[`rooms/${roomCode}/wallets/${loan.borrowerId}/cash`] = (borrowerWallet.cash||0) - o.total;
        updates[`rooms/${roomCode}/wallets/${loan.borrowerId}/btc`] = (borrowerWallet.btc||0) + loan.collateralBtc;
        updates[`rooms/${roomCode}/wallets/${loan.lenderId}/cash`] = (lenderWallet.cash||0) + o.total;
        updates[`rooms/${roomCode}/wallets/${loan.lenderId}/totalInterest`] = (lenderWallet.totalInterest||0) + o.interest;
        totalRepaid++;
        newLog.push({ day, msg: `MATURED: ${loan.borrowerName} repaid ${fUSD(o.total)} to ${loan.lenderName}`, type:'up' });
      } else {
        // default ‚Äî seize collateral
        updates[`rooms/${roomCode}/loans/${lid}/status`] = 'defaulted';
        updates[`rooms/${roomCode}/wallets/${loan.lenderId}/cash`] = (lenderWallet.cash||0) + loan.collateralBtc * price;
        totalDefaults++;
        newLog.push({ day, msg: `DEFAULT: ${loan.borrowerName} couldn't repay ${fUSD(o.total)} ‚Äî collateral seized`, type:'down' });
      }
    }
  }

  const dir = price >= (game.price||65000) ? '‚ñ≤' : '‚ñº';
  const chg = ((price-(game.price||65000))/(game.price||65000)*100).toFixed(2);
  newLog.unshift({ day, msg: `Day ${day}: BTC ${fUSD(price)} ${dir}${chg}%`, type: price>=(game.price||65000)?'up':'down' });

  const prevLog = game.log || [];
  updates[`rooms/${roomCode}/game/day`] = day;
  updates[`rooms/${roomCode}/game/price`] = price;
  updates[`rooms/${roomCode}/game/priceHistory`] = hist;
  updates[`rooms/${roomCode}/game/totalDefaults`] = totalDefaults;
  updates[`rooms/${roomCode}/game/totalRepaid`] = totalRepaid;
  updates[`rooms/${roomCode}/game/log`] = [...prevLog.slice(-80), ...newLog];

  await db.ref().update(updates);
}

async function triggerShock(type) {
  const snap = await db.ref(`rooms/${roomCode}/game/price`).once('value');
  const price = snap.val() || 65000;
  const newPrice = type === 'crash' ? price * (0.7 + Math.random()*0.1) : price * (1.2 + Math.random()*0.15);
  const day = (await db.ref(`rooms/${roomCode}/game/day`).once('value')).val() || 0;
  const hist = (await db.ref(`rooms/${roomCode}/game/priceHistory`).once('value')).val() || [price];
  const prevLog = (await db.ref(`rooms/${roomCode}/game/log`).once('value')).val() || [];
  const msg = type === 'crash' ? `üí• MARKET CRASH! BTC ${fUSD(price)} ‚Üí ${fUSD(newPrice)}` : `üöÄ PRICE PUMP! BTC ${fUSD(price)} ‚Üí ${fUSD(newPrice)}`;
  await db.ref(`rooms/${roomCode}/game`).update({
    price: newPrice,
    priceHistory: [...hist.slice(-60), newPrice],
    log: [...prevLog.slice(-80), { day, msg, type: type==='crash'?'down':'up' }]
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LENDER DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initLenderDashboard() {
  el('lender-name').textContent = myName;

  db.ref(`rooms/${roomCode}/game`).on('value', snap => {
    gameData = snap.val() || {};
    updateLenderHeader();
  });
  db.ref(`rooms/${roomCode}/wallets/${myId}`).on('value', snap => {
    const wallet = snap.val() || {};
    updateLenderWallet(wallet);
  });
  db.ref(`rooms/${roomCode}/loans`).on('value', snap => {
    loansData = snap.val() || {};
    renderLenderLoans();
    renderLenderRequests();
  });
}

function updateLenderHeader() {
  const day = gameData.day || 0;
  const price = gameData.price || 65000;
  const hist = gameData.priceHistory || [price];
  el('lender-day-badge').textContent = `DAY ${day}`;
  el('l-price').textContent = fUSD(price);
  el('l-ticker-price').textContent = `BTC: ${fUSD(price)}`;
  el('l-ticker-day').textContent = `Day: ${day}`;
  el('l-ticker-name').textContent = `You: ${myName} (Lender)`;
  drawChart('l-chart', hist, 180, 30);
}

function updateLenderWallet(wallet) {
  const activeLoanTotal = Object.values(loansData).filter(l=>l.lenderId===myId&&l.status==='active').reduce((s,l)=>s+l.amount,0);
  el('l-cash').textContent = fUSD(wallet.cash || 0);
  el('l-cash-locked').textContent = `Locked: ${fUSD(activeLoanTotal)}`;
  el('l-lent').textContent = fUSD(wallet.totalLent || 0);
  el('l-interest-earned').textContent = `Interest earned: ${fUSD(wallet.totalInterest || 0)}`;
}

async function publishOffer() {
  const rate = parseFloat(el('l-rate').value) || 10;
  const ltv = parseFloat(el('l-ltv').value) || 50;
  const maxLoan = parseFloat(el('l-maxloan').value) || 20000;
  await db.ref(`rooms/${roomCode}/offers/${myId}`).set({
    lenderId: myId, lenderName: myName,
    rate, ltv, maxLoan,
    updatedAt: Date.now(), active: true
  });
  el('l-offer-status').textContent = '‚úì Offer published';
  setTimeout(() => el('l-offer-status').textContent = '', 2000);
}

function renderLenderRequests() {
  const requests = Object.entries(loansData).filter(([,l]) => l.lenderId===myId && l.status==='pending');
  el('l-req-count').textContent = requests.length;
  requests.length ? show('l-req-badge') : hide('l-req-badge');

  if (!requests.length) {
    el('l-requests-list').innerHTML = '<p style="font-size:12px;color:var(--muted);text-align:center;padding:20px;font-family:var(--mono)">No requests yet.</p>';
    return;
  }
  const day = gameData.day || 0;
  const price = gameData.price || 65000;
  el('l-requests-list').innerHTML = requests.map(([lid, l]) => {
    const collVal = l.collateralBtc * price;
    const ltvCur = (l.amount / collVal * 100).toFixed(1);
    return `<div class="request-card pending">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <span style="font-weight:700;font-size:13px">${l.borrowerName}</span>
        <span class="badge badge-borrower">Borrower</span>
      </div>
      <div class="grid2" style="font-family:var(--mono);font-size:11px;gap:6px;margin-bottom:10px">
        <div><span style="color:var(--muted2)">Amount: </span>${fUSD(l.amount)}</div>
        <div><span style="color:var(--muted2)">Duration: </span>${l.duration}d</div>
        <div><span style="color:var(--muted2)">Collateral: </span>${fBTC(l.collateralBtc)}</div>
        <div><span style="color:var(--muted2)">Current LTV: </span>${ltvCur}%</div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-green btn-sm" style="flex:1" onclick="respondLoan('${lid}','approve')">Approve</button>
        <button class="btn btn-red btn-sm" style="flex:1" onclick="respondLoan('${lid}','reject')">Reject</button>
      </div>
    </div>`;
  }).join('');
}

function renderLenderLoans() {
  const myLoans = Object.entries(loansData).filter(([,l]) => l.lenderId===myId && l.status==='active');
  if (!myLoans.length) {
    el('l-active-loans').innerHTML = '<p style="font-size:12px;color:var(--muted);text-align:center;padding:20px;font-family:var(--mono)">No active loans.</p>';
    return;
  }
  const day = gameData.day || 0;
  const price = gameData.price || 65000;
  el('l-active-loans').innerHTML = myLoans.map(([lid, l]) => {
    const o = owed(l, day);
    const health = (l.collateralBtc * price) / o.total;
    const hColor = health > 1.5 ? 'var(--green)' : health > 1.1 ? 'var(--gold)' : 'var(--red)';
    const drem = Math.max((l.originDay+l.duration)-day,0);
    return `<div class="loan-card ${drem<=3?'urgent':drem<=7?'warning':''}">
      <div style="display:flex;justify-content:space-between;margin-bottom:6px">
        <span style="font-weight:700">${l.borrowerName}</span>
        <span style="font-family:var(--mono);font-size:11px;color:${drem<=3?'var(--red)':'var(--muted2)'}">${drem}d left</span>
      </div>
      <div class="grid2" style="font-family:var(--mono);font-size:11px;gap:4px">
        <div><span style="color:var(--muted2)">Principal: </span>${fUSD(l.amount)}</div>
        <div><span style="color:var(--muted2)">Owed: </span><span style="color:var(--orange)">${fUSD(o.total)}</span></div>
        <div><span style="color:var(--muted2)">Collateral: </span>${fBTC(l.collateralBtc)}</div>
        <div><span style="color:var(--muted2)">Health: </span><span style="color:${hColor}">${health.toFixed(2)}x</span></div>
      </div>
    </div>`;
  }).join('');
}

async function respondLoan(loanId, decision) {
  const loan = loansData[loanId];
  if (!loan) return;
  if (decision === 'approve') {
    // deduct cash from lender, give cash to borrower
    const lenderSnap = await db.ref(`rooms/${roomCode}/wallets/${myId}`).once('value');
    const lw = lenderSnap.val() || {};
    const borrowerSnap = await db.ref(`rooms/${roomCode}/wallets/${loan.borrowerId}`).once('value');
    const bw = borrowerSnap.val() || {};
    if ((lw.cash||0) < loan.amount) {
      alert('Insufficient funds to approve this loan!'); return;
    }
    await db.ref().update({
      [`rooms/${roomCode}/loans/${loanId}/status`]: 'active',
      [`rooms/${roomCode}/wallets/${myId}/cash`]: (lw.cash||0) - loan.amount,
      [`rooms/${roomCode}/wallets/${myId}/totalLent`]: (lw.totalLent||0) + loan.amount,
      [`rooms/${roomCode}/wallets/${loan.borrowerId}/cash`]: (bw.cash||0) + loan.amount,
    });
    addLog(`${myName} approved ${loan.borrowerName}'s loan for ${fUSD(loan.amount)}`, 'up');
  } else {
    await db.ref(`rooms/${roomCode}/loans/${loanId}/status`).set('rejected');
    addLog(`${myName} rejected ${loan.borrowerName}'s loan request`, 'warn');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BORROWER DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initBorrowerDashboard() {
  el('borrower-name').textContent = myName;

  db.ref(`rooms/${roomCode}/game`).on('value', snap => {
    gameData = snap.val() || {};
    updateBorrowerHeader();
  });
  db.ref(`rooms/${roomCode}/wallets/${myId}`).on('value', snap => {
    const wallet = snap.val() || {};
    updateBorrowerWallet(wallet);
  });
  db.ref(`rooms/${roomCode}/offers`).on('value', snap => {
    offersData = snap.val() || {};
    renderBorrowerOffers();
  });
  db.ref(`rooms/${roomCode}/loans`).on('value', snap => {
    loansData = snap.val() || {};
    renderBorrowerLoans();
  });
}

function updateBorrowerHeader() {
  const day = gameData.day || 0;
  const price = gameData.price || 65000;
  const hist = gameData.priceHistory || [price];
  el('borrower-day-badge').textContent = `DAY ${day}`;
  el('b-ticker-price').textContent = `BTC: ${fUSD(price)}`;
  el('b-ticker-day').textContent = `Day: ${day}`;
  el('b-ticker-name').textContent = `You: ${myName} (Borrower)`;
  drawChart('b-chart', hist, 180, 30);
}

async function updateBorrowerWallet(wallet) {
  const price = gameData.price || 65000;
  const myLoans = Object.values(loansData).filter(l=>l.borrowerId===myId&&l.status==='active');
  const totalDebt = myLoans.reduce((s,l)=>s+owed(l,gameData.day||0).total,0);
  const lockedBtc = myLoans.reduce((s,l)=>s+l.collateralBtc,0);
  const nw = (wallet.btc||0)*price + (wallet.cash||0) - totalDebt;

  el('b-btc').textContent = fBTC(wallet.btc||0);
  el('b-btc-usd').textContent = `‚âà ${fUSD((wallet.btc||0)*price)}`;
  el('b-cash').textContent = fUSD(wallet.cash||0);
  el('b-debt').textContent = `Debt: ${fUSD(totalDebt)}`;
  el('b-networth').textContent = fUSD(nw);
}

function renderBorrowerOffers() {
  const offers = Object.entries(offersData).filter(([,o])=>o.active);
  el('b-offer-count').textContent = offers.length;
  if (!offers.length) {
    el('b-offers-list').innerHTML = '<p style="font-size:12px;color:var(--muted);text-align:center;padding:20px;font-family:var(--mono)">No offers available yet.<br>Waiting for lenders to post...</p>';
    return;
  }
  // Sort by rate ascending
  offers.sort(([,a],[,b]) => a.rate - b.rate);
  el('b-offers-list').innerHTML = offers.map(([lid, o]) => `
    <div class="offer-card" onclick="openBorrowModal('${lid}')">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <span style="font-weight:700;font-size:13px">${o.lenderName}</span>
        <span style="font-family:var(--mono);font-size:18px;font-weight:600;color:var(--green)">${o.rate}% APR</span>
      </div>
      <div class="grid2" style="font-family:var(--mono);font-size:11px;gap:4px">
        <div><span style="color:var(--muted2)">Max LTV: </span>${o.ltv}%</div>
        <div><span style="color:var(--muted2)">Max Loan: </span>${fUSD(o.maxLoan)}</div>
      </div>
      <div style="margin-top:10px;font-size:11px;color:var(--blue)">Tap to request loan ‚Üí</div>
    </div>
  `).join('');
}

function renderBorrowerLoans() {
  const myLoans = Object.entries(loansData).filter(([,l])=>l.borrowerId===myId);
  el('b-loan-count').textContent = myLoans.filter(([,l])=>l.status==='active').length;
  if (!myLoans.length) {
    el('b-loans-list').innerHTML = '<p style="font-size:12px;color:var(--muted);text-align:center;padding:20px;font-family:var(--mono)">No loans yet.</p>';
    return;
  }
  const day = gameData.day || 0;
  const price = gameData.price || 65000;
  el('b-loans-list').innerHTML = myLoans.map(([lid, l]) => {
    if (l.status === 'pending') {
      return `<div class="loan-card"><div style="display:flex;justify-content:space-between;align-items:center">
        <span style="font-size:12px;">Request to <b>${l.lenderName}</b></span>
        <span class="badge" style="background:rgba(245,200,66,0.15);color:var(--gold);border:1px solid rgba(245,200,66,0.3);animation:pulse 1.5s infinite">Pending...</span>
      </div></div>`;
    }
    if (l.status === 'rejected') {
      return `<div class="loan-card" style="opacity:0.5"><div style="display:flex;justify-content:space-between">
        <span style="font-size:12px;">Request to <b>${l.lenderName}</b></span>
        <span class="badge" style="background:rgba(255,59,92,0.1);color:var(--red);">Rejected</span>
      </div></div>`;
    }
    if (l.status !== 'active') return '';
    const o = owed(l, day);
    const health = (l.collateralBtc * price) / o.total;
    const hColor = health > 1.5 ? 'var(--green)' : health > 1.1 ? 'var(--gold)' : 'var(--red)';
    const drem = Math.max((l.originDay+l.duration)-day, 0);
    return `<div class="loan-card ${drem<=3?'urgent':drem<=7?'warning':''}">
      <div style="display:flex;justify-content:space-between;margin-bottom:6px">
        <span style="font-weight:700">From: ${l.lenderName}</span>
        <span style="font-family:var(--mono);font-size:11px;color:${drem<=3?'var(--red)':'var(--muted2)'}">${drem}d left</span>
      </div>
      <div class="grid2" style="font-family:var(--mono);font-size:11px;gap:4px;margin-bottom:10px">
        <div><span style="color:var(--muted2)">Principal: </span>${fUSD(l.amount)}</div>
        <div><span style="color:var(--muted2)">Owed: </span><span style="color:var(--orange)">${fUSD(o.total)}</span></div>
        <div><span style="color:var(--muted2)">Collateral: </span>${fBTC(l.collateralBtc)}</div>
        <div><span style="color:var(--muted2)">Health: </span><span style="color:${hColor}">${health.toFixed(2)}x</span></div>
      </div>
      <div class="hbar"><div class="hbar-fill" style="width:${Math.min(health/2*100,100)}%;background:${hColor}"></div></div>
      <button class="btn btn-green btn-sm btn-full" style="margin-top:10px" onclick="openRepayModal('${lid}')">Repay Loan</button>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BORROW MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openBorrowModal(lenderId) {
  selectedOffer = { id: lenderId, ...offersData[lenderId] };
  el('bm-lender-info').textContent = `From: ${selectedOffer.lenderName} ¬∑ ${selectedOffer.rate}% APR ¬∑ Max LTV ${selectedOffer.ltv}%`;
  el('bm-amount').value = '';
  el('bm-preview').style.display = 'none';
  setBorrowDur(30);

  // Pct buttons
  const wallet = {}; // will get from DB
  db.ref(`rooms/${roomCode}/wallets/${myId}`).once('value').then(snap => {
    const w = snap.val() || {};
    const price = gameData.price || 65000;
    const maxBorrow = Math.min(w.btc * price * selectedOffer.ltv/100, selectedOffer.maxLoan);
    el('bm-pct-btns').innerHTML = [0.25,0.5,0.75,1].map(p =>
      `<button class="btn btn-surface btn-sm" style="flex:1" onclick="el('bm-amount').value=${(maxBorrow*p).toFixed(0)};updateBorrowPreview()">${p*100}%</button>`
    ).join('');
  });

  el('borrow-modal').style.display = 'flex';
}

function closeBorrowModal() { el('borrow-modal').style.display = 'none'; }

function setBorrowDur(d) {
  borrowDuration = d;
  document.querySelectorAll('#bm-dur-btns button').forEach(btn => {
    const active = parseInt(btn.dataset.dur) === d;
    btn.className = active ? 'btn btn-gold btn-sm' : 'btn btn-surface btn-sm';
  });
  updateBorrowPreview();
}

function updateBorrowPreview() {
  if (!selectedOffer) return;
  const amt = parseFloat(el('bm-amount').value);
  if (!amt || amt <= 0) { el('bm-preview').style.display = 'none'; return; }
  const price = gameData.price || 65000;
  const ltv = selectedOffer.ltv / 100;
  const coll = amt / (price * ltv);
  const interest = amt * (selectedOffer.rate/100) * (borrowDuration/365);
  const liqPrice = amt / coll;
  el('bm-preview').style.display = '';
  el('bm-preview').innerHTML = `
    <div style="display:flex;justify-content:space-between;margin-bottom:5px"><span style="color:var(--muted2)">Collateral needed</span><span>${fBTC(coll)}</span></div>
    <div style="display:flex;justify-content:space-between;margin-bottom:5px"><span style="color:var(--muted2)">Liquidation price</span><span style="color:var(--red)">${fUSD(liqPrice)}</span></div>
    <div style="display:flex;justify-content:space-between;margin-bottom:5px"><span style="color:var(--muted2)">Interest (${borrowDuration}d)</span><span>${fUSD(interest)}</span></div>
    <div style="display:flex;justify-content:space-between"><span style="color:var(--muted2)">Total to repay</span><span style="color:var(--orange)">${fUSD(amt+interest)}</span></div>`;
}

async function submitBorrowRequest() {
  const amt = parseFloat(el('bm-amount').value);
  if (!amt || amt <= 0 || !selectedOffer) return;
  const price = gameData.price || 65000;
  const day = gameData.day || 0;
  const ltv = selectedOffer.ltv / 100;
  const coll = amt / (price * ltv);

  const snap = await db.ref(`rooms/${roomCode}/wallets/${myId}`).once('value');
  const wallet = snap.val() || {};
  if ((wallet.btc||0) < coll) { alert('Not enough BTC for collateral!'); return; }
  if (amt > selectedOffer.maxLoan) { alert(`Max loan size is ${fUSD(selectedOffer.maxLoan)}`); return; }

  const loanId = uid();
  await db.ref().update({
    [`rooms/${roomCode}/loans/${loanId}`]: {
      borrowerId: myId, borrowerName: myName,
      lenderId: selectedOffer.id, lenderName: selectedOffer.lenderName,
      amount: amt, collateralBtc: coll, rate: selectedOffer.rate,
      ltv, ltvLimit: ltv * 1.1,
      duration: borrowDuration, originDay: day, status: 'pending',
      requestedAt: Date.now()
    },
    [`rooms/${roomCode}/wallets/${myId}/btc`]: (wallet.btc||0) - coll,
  });
  addLog(`${myName} requested ${fUSD(amt)} from ${selectedOffer.lenderName}`, 'gold');
  closeBorrowModal();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REPAY MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openRepayModal(loanId) {
  repayLoanId = loanId;
  const loan = loansData[loanId];
  if (!loan) return;
  const day = gameData.day || 0;
  const o = owed(loan, day);
  el('rm-info').textContent = `Loan from ${loan.lenderName} ¬∑ originated Day ${loan.originDay}`;
  el('rm-details').innerHTML = `
    <div style="display:flex;justify-content:space-between;margin-bottom:5px"><span style="color:var(--muted2)">Principal</span><span>${fUSD(loan.amount)}</span></div>
    <div style="display:flex;justify-content:space-between;margin-bottom:5px"><span style="color:var(--muted2)">Interest accrued</span><span style="color:var(--orange)">${fUSD(o.interest)}</span></div>
    <div style="display:flex;justify-content:space-between;margin-bottom:5px"><span style="color:var(--muted2)">Total due</span><span style="font-weight:700">${fUSD(o.total)}</span></div>
    <div style="display:flex;justify-content:space-between"><span style="color:var(--muted2)">Collateral returned</span><span style="color:var(--green)">${fBTC(loan.collateralBtc)}</span></div>`;
  el('repay-modal').style.display = 'flex';
}

function closeRepayModal() { el('repay-modal').style.display = 'none'; }

async function confirmRepay() {
  const loan = loansData[repayLoanId];
  if (!loan) return;
  const day = gameData.day || 0;
  const o = owed(loan, day);

  const bSnap = await db.ref(`rooms/${roomCode}/wallets/${myId}`).once('value');
  const bw = bSnap.val() || {};
  if ((bw.cash||0) < o.total) { alert(`Not enough cash. Need ${fUSD(o.total)}, have ${fUSD(bw.cash||0)}`); return; }

  const lSnap = await db.ref(`rooms/${roomCode}/wallets/${loan.lenderId}`).once('value');
  const lw = lSnap.val() || {};

  await db.ref().update({
    [`rooms/${roomCode}/loans/${repayLoanId}/status`]: 'repaid',
    [`rooms/${roomCode}/wallets/${myId}/cash`]: (bw.cash||0) - o.total,
    [`rooms/${roomCode}/wallets/${myId}/btc`]: (bw.btc||0) + loan.collateralBtc,
    [`rooms/${roomCode}/wallets/${loan.lenderId}/cash`]: (lw.cash||0) + o.total,
    [`rooms/${roomCode}/wallets/${loan.lenderId}/totalInterest`]: (lw.totalInterest||0) + o.interest,
  });
  addLog(`${myName} repaid ${fUSD(o.total)} to ${loan.lenderName}`, 'up');
  closeRepayModal();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function simPrice(p) { return Math.max(p * Math.exp(0.0002 + (Math.random()-0.5)*0.08), 1000); }

async function addLog(msg, type='info') {
  const day = gameData.day || 0;
  const logRef = db.ref(`rooms/${roomCode}/game/log`);
  const snap = await logRef.once('value');
  const log = snap.val() || [];
  await logRef.set([...log.slice(-80), { day, msg, type }]);
}

function drawChart(canvasId, data, w, h) {
  const canvas = el(canvasId);
  if (!canvas || data.length < 2) return;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, w, h);
  const mn = Math.min(...data), mx = Math.max(...data), r = mx-mn||1;
  const pts = data.map((v,i) => [i/(data.length-1)*w, h-((v-mn)/r)*(h-4)-2]);
  const last = data[data.length-1], prev = data[data.length-2];
  const color = last >= prev ? '#00d68f' : '#ff3b5c';
  ctx.beginPath();
  ctx.strokeStyle = color;
  ctx.lineWidth = 1.5;
  ctx.lineJoin = 'round';
  pts.forEach(([x,y], i) => i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y));
  ctx.stroke();
  // fill
  const grad = ctx.createLinearGradient(0,0,0,h);
  grad.addColorStop(0, last>=prev?'rgba(0,214,143,0.15)':'rgba(255,59,92,0.15)');
  grad.addColorStop(1, 'transparent');
  ctx.lineTo(w, h); ctx.lineTo(0, h); ctx.closePath();
  ctx.fillStyle = grad; ctx.fill();
}

// make el accessible in inline handlers
window.el = el;
</script>
</body>
</html>
