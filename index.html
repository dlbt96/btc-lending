<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>‚Çø Collateral Protocol ‚Äî Multiplayer</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&display=swap');
:root{
  --bg:#060a0f;--surface:#0d1520;--s2:#111e2e;--s3:#0a1018;
  --border:#1a2d42;--border2:#243d58;
  --gold:#f5c842;--green:#00d68f;--red:#ff3b5c;--blue:#3d9bff;--orange:#ff7a3d;--purple:#9b6dff;
  --text:#e8eef5;--muted:#4a6080;--muted2:#6b8aaa;
  --font:'Syne',sans-serif;--mono:'DM Mono',monospace;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--font);overflow-x:hidden}
::-webkit-scrollbar{width:3px;height:3px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
.screen{display:none;flex-direction:column;min-height:100vh;padding:20px;max-width:1280px;margin:0 auto;width:100%}
.screen.active{display:flex}
h1{font-size:clamp(26px,5vw,48px);font-weight:800;letter-spacing:-1px;line-height:1}
h2{font-size:clamp(16px,3vw,24px);font-weight:700}
h3{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:var(--muted2)}
.mono{font-family:var(--mono)}
.card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:16px;position:relative;overflow:hidden}
.card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(61,155,255,.03),transparent 60%);pointer-events:none}
.csm{padding:12px;border-radius:10px}
.btn{font-family:var(--font);font-weight:700;font-size:12px;letter-spacing:.4px;border:none;border-radius:9px;cursor:pointer;padding:10px 18px;transition:all .15s;white-space:nowrap}
.btn:hover{transform:translateY(-1px);filter:brightness(1.12)}
.btn:active{transform:translateY(0);filter:brightness(.95)}
.btn:disabled{opacity:.35;cursor:not-allowed;transform:none;filter:none}
.btn-gold{background:var(--gold);color:#0a0a0a}
.btn-green{background:var(--green);color:#0a0a0a}
.btn-red{background:var(--red);color:#fff}
.btn-blue{background:var(--blue);color:#fff}
.btn-purple{background:var(--purple);color:#fff}
.btn-ghost{background:transparent;color:var(--muted2);border:1px solid var(--border2)}
.btn-ghost:hover{background:var(--s2);color:var(--text)}
.btn-surface{background:var(--s2);color:var(--text);border:1px solid var(--border)}
.btn-lg{padding:14px 28px;font-size:15px;border-radius:12px}
.btn-sm{padding:6px 12px;font-size:11px;border-radius:7px}
.btn-xs{padding:4px 8px;font-size:10px;border-radius:5px}
.btn-full{width:100%}
.inp{background:var(--bg);border:1px solid var(--border2);border-radius:9px;padding:10px 14px;color:var(--text);font-family:var(--mono);font-size:14px;outline:none;width:100%;transition:border-color .2s}
.inp:focus{border-color:var(--gold)}
.inp::placeholder{color:var(--muted)}
.badge{display:inline-flex;align-items:center;gap:4px;font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;padding:3px 8px;border-radius:20px}
.bl{background:rgba(0,214,143,.15);color:var(--green);border:1px solid rgba(0,214,143,.3)}
.bb{background:rgba(245,200,66,.15);color:var(--gold);border:1px solid rgba(245,200,66,.3)}
.bt2{background:rgba(61,155,255,.15);color:var(--blue);border:1px solid rgba(61,155,255,.3)}
.bp{background:rgba(155,109,255,.15);color:var(--purple);border:1px solid rgba(155,109,255,.3)}
.tag{font-family:var(--mono);font-size:10px;color:var(--muted2);background:var(--s2);border:1px solid var(--border);border-radius:4px;padding:2px 6px}
.tabs{display:flex;gap:5px;background:var(--s2);border-radius:10px;padding:4px}
.tab{flex:1;text-align:center;padding:7px;border-radius:7px;cursor:pointer;font-size:11px;font-weight:700;color:var(--muted2);transition:all .2s;border:none;background:transparent;font-family:var(--font)}
.tab.active{background:var(--surface);color:var(--text);box-shadow:0 2px 8px rgba(0,0,0,.4)}
.divider{height:1px;background:var(--border);margin:14px 0}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.g4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px}
.stat-label{font-size:10px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted)}
.stat-value{font-family:var(--mono);font-size:20px;font-weight:500;margin-top:2px}
.stat-sub{font-family:var(--mono);font-size:11px;color:var(--muted2);margin-top:2px}
.hbar{height:4px;border-radius:2px;background:var(--border);overflow:hidden;margin-top:4px}
.hbar-fill{height:100%;border-radius:2px;transition:width .5s}
.ticker{font-family:var(--mono);background:var(--s2);border-bottom:1px solid var(--border);padding:7px 20px;font-size:11px;color:var(--muted2);display:flex;gap:20px;flex-wrap:wrap}
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:200;backdrop-filter:blur(4px)}
.modal{background:var(--surface);border:1px solid var(--border2);border-radius:18px;padding:24px;width:460px;max-width:96vw;max-height:90vh;overflow-y:auto}
.loan-card{background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:8px}
.loan-card.urgent{border-color:var(--red);background:rgba(255,59,92,.05)}
.loan-card.warning{border-color:var(--gold);background:rgba(245,200,66,.05)}
.offer-card{background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:8px;cursor:pointer;transition:all .2s}
.offer-card:hover{border-color:var(--border2);transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,0,0,.3)}
.req-card{background:var(--s2);border-left:3px solid var(--gold);border-radius:0 10px 10px 0;padding:12px;margin-bottom:8px}
.req-card.approved{border-left-color:var(--green)}
.req-card.rejected{border-left-color:var(--red);opacity:.5}
.player-row{display:flex;align-items:center;justify-content:space-between;padding:9px 12px;background:var(--s2);border-radius:9px;margin-bottom:5px;font-size:12px}
.dot{width:7px;height:7px;border-radius:50%;display:inline-block}
.dot-green{background:var(--green)}
.dot-gray{background:var(--muted)}
.log-entry{font-family:var(--mono);font-size:10px;padding:4px 0;border-bottom:1px solid rgba(26,45,66,.5);line-height:1.5}
.log-entry:last-child{border-bottom:none}
.log-up{color:var(--green)}.log-down{color:var(--red)}.log-warn{color:var(--orange)}.log-info{color:var(--muted2)}.log-gold{color:var(--gold)}.log-purple{color:var(--purple)}
.history-row{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;background:var(--s3);border-radius:7px;margin-bottom:4px;font-family:var(--mono);font-size:11px}
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes slideIn{from{opacity:0;transform:translateX(-8px)}to{opacity:1;transform:translateX(0)}}
.fade-up{animation:fadeUp .4s ease forwards}
.blink{animation:pulse 1.5s infinite}
.spin{animation:spin .8s linear infinite}
.role-reveal{background:var(--surface);border:2px solid var(--border2);border-radius:18px;padding:36px 28px;text-align:center;animation:fadeUp .5s ease}
.role-icon{font-size:60px;margin-bottom:14px;display:block}
.section-tabs{display:flex;gap:6px;margin-bottom:14px}
.section-tab{padding:7px 14px;border-radius:8px;cursor:pointer;font-size:11px;font-weight:700;color:var(--muted2);border:1px solid var(--border);background:transparent;font-family:var(--font);transition:all .2s}
.section-tab.active{background:var(--s2);color:var(--text);border-color:var(--border2)}
@media(max-width:700px){.g2,.g3,.g4{grid-template-columns:1fr}.screen{padding:12px}}
</style>
</head>
<body>

<!-- Loading -->
<div id="loading-overlay" style="position:fixed;inset:0;background:#060a0f;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999">
  <div style="font-size:44px;margin-bottom:14px">‚Çø</div>
  <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;color:var(--gold);margin-bottom:6px">Collateral Protocol</div>
  <div style="width:22px;height:22px;border:2px solid #1a2d42;border-top-color:var(--gold);border-radius:50%;animation:spin .8s linear infinite;margin-top:14px"></div>
  <div style="font-family:monospace;font-size:11px;color:#4a6080;margin-top:10px" id="loading-msg">Connecting...</div>
</div>

<div id="app">

<!-- ‚ïê‚ïê‚ïê JOIN ‚ïê‚ïê‚ïê -->
<div class="screen active" id="screen-join">
  <div style="max-width:420px;margin:auto;padding-top:50px;width:100%">
    <div style="text-align:center;margin-bottom:30px">
      <div style="font-size:44px;margin-bottom:10px">‚Çø</div>
      <h1>Collateral<br>Protocol</h1>
      <p style="color:var(--muted2);margin-top:8px;font-size:12px;font-family:var(--mono)">Real-time multiplayer DeFi lending</p>
    </div>
    <div class="card" style="margin-bottom:12px">
      <h3 style="margin-bottom:12px">Your name</h3>
      <input class="inp" id="player-name" placeholder="Enter your name..." maxlength="20" style="margin-bottom:14px"/>
      <div class="tabs" id="join-tabs" style="margin-bottom:14px">
        <button class="tab active" onclick="setJoinMode('join')" id="tab-join">Join Game</button>
        <button class="tab" onclick="setJoinMode('create')" id="tab-create">Create Game</button>
      </div>
      <div id="join-panel">
        <input class="inp" id="room-code-input" placeholder="ROOM CODE" maxlength="8" style="margin-bottom:12px;text-transform:uppercase;font-size:20px;text-align:center;letter-spacing:5px"/>
        <button class="btn btn-gold btn-full btn-lg" onclick="joinRoom()">Join ‚Üí</button>
      </div>
      <div id="create-panel" style="display:none">
        <div style="display:flex;gap:8px;margin-bottom:10px">
          <button class="btn btn-surface" style="flex:1;padding:14px 8px" onclick="joinAsTeacher()"><div style="font-size:20px">üéì</div><div style="font-size:10px;margin-top:4px">Teacher</div></button>
          <button class="btn btn-surface" style="flex:1;padding:14px 8px" onclick="createRoom()"><div style="font-size:20px">üéÆ</div><div style="font-size:10px;margin-top:4px">Student Host</div></button>
        </div>
      </div>
      <div id="join-error" style="color:var(--red);font-size:11px;margin-top:8px;display:none;text-align:center;font-family:var(--mono)"></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê LOBBY ‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-lobby">
  <div style="max-width:580px;margin:auto;width:100%">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;padding-top:20px">
      <div><h2>Game Lobby</h2><p style="font-size:11px;color:var(--muted2);font-family:var(--mono);margin-top:2px">Waiting for players...</p></div>
      <div style="text-align:right">
        <div style="font-size:10px;color:var(--muted2);margin-bottom:3px">Room Code</div>
        <div id="lobby-room-code" style="font-family:var(--mono);font-size:26px;font-weight:500;color:var(--gold);letter-spacing:5px">‚Äî‚Äî</div>
      </div>
    </div>
    <div class="card" style="margin-bottom:14px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <h3>Players (<span id="player-count">0</span>)</h3><span class="tag">Share room code above</span>
      </div>
      <div id="player-list"></div>
    </div>
    <div class="card" style="margin-bottom:14px">
      <h3 style="margin-bottom:12px">Game Settings</h3>
      <div class="g2" style="gap:10px">
        <div><div style="font-size:10px;color:var(--muted2);margin-bottom:5px;font-family:var(--mono)">Starting Cash (USD)</div><input class="inp" id="setting-cash" type="number" value="50000" step="5000" min="5000"/></div>
        <div><div style="font-size:10px;color:var(--muted2);margin-bottom:5px;font-family:var(--mono)">Starting BTC</div><input class="inp" id="setting-btc" type="number" value="1.0" step="0.1" min="0.1" max="10"/></div>
        <div><div style="font-size:10px;color:var(--muted2);margin-bottom:5px;font-family:var(--mono)">BTC Start Price</div><input class="inp" id="setting-price" type="number" value="65000" step="1000" min="10000"/></div>
        <div><div style="font-size:10px;color:var(--muted2);margin-bottom:5px;font-family:var(--mono)">œÑ threshold</div><input class="inp" id="setting-tau" type="number" value="2" step="1" min="1" max="10"/></div>
        <div><div style="font-size:10px;color:var(--muted2);margin-bottom:5px;font-family:var(--mono)">Auto-clock speed (sec/day, 0 = off)</div><input class="inp" id="setting-speed" type="number" value="0" step="1" min="0" max="300"/></div>
      </div>
    </div>
    <div id="teacher-lobby-controls">
      <button class="btn btn-gold btn-full btn-lg" onclick="startGame()">Start Game ‚Üí</button>
      
    </div>
    <div id="student-lobby-wait" style="display:none">
      <div class="card" style="text-align:center;padding:22px;background:rgba(245,200,66,.05);border-color:rgba(245,200,66,.2)">
        <div class="spin" style="width:22px;height:22px;border:2px solid var(--border2);border-top-color:var(--gold);border-radius:50%;margin:0 auto 10px"></div>
        <p style="color:var(--muted2);font-size:12px;font-family:var(--mono)">Waiting for teacher to start...</p>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê TEACHER ‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-teacher">
  <div class="ticker" style="margin:-20px -20px 16px -20px">
    <span>BTC: <span id="t-tick-price" style="color:var(--gold)">‚Äî</span></span>
    <span>Day: <span id="t-tick-day">0</span></span>
    <span>Players: <span id="t-tick-players">0</span></span>
    <span>Loans: <span id="t-tick-loans">0</span></span>
    <span>Vol: <span id="t-tick-vol">‚Äî</span></span>
    <span>D/R: <span id="t-tick-dr" style="color:var(--red)">0</span>/<span id="t-tick-rp" style="color:var(--green)">0</span></span>
  </div>

  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px">
    <div>
      <h2>Teacher Dashboard</h2>
      <p style="font-size:11px;color:var(--muted2);font-family:var(--mono);margin-top:2px">Room: <span id="t-room-code" style="color:var(--gold);letter-spacing:2px">‚Äî‚Äî</span></p>
    </div>
    <div style="display:flex;gap:7px;align-items:center;flex-wrap:wrap">
      <span id="t-day-badge" class="badge bb" style="font-size:12px">DAY 0</span>
      <button class="btn btn-gold" id="t-advance-btn" onclick="advanceDay()">‚è≠ Next Day</button>
      <button class="btn btn-surface btn-sm" id="t-auto-btn" onclick="toggleAutoClock()">‚ñ∂ Auto</button>
      <span id="t-auto-status" style="font-family:var(--mono);font-size:10px;color:var(--muted2);display:none"></span>
      <button class="btn btn-surface btn-sm" onclick="triggerShock('crash')">üí• ‚àí25%</button>
      <button class="btn btn-surface btn-sm" onclick="triggerShock('pump')">üöÄ +25%</button>
      <button class="btn btn-surface btn-sm" onclick="triggerShock('minibull')">üìà +10%</button>
      <button class="btn btn-surface btn-sm" onclick="triggerShock('minibear')">üìâ ‚àí10%</button>
    </div>
  </div>

  <div class="g4" style="margin-bottom:14px">
    <div class="card csm">
      <div class="stat-label">BTC Price</div>
      <div class="stat-value" id="t-price" style="color:var(--gold)">‚Äî</div>
      <div class="stat-sub" id="t-price-chg">‚Äî</div>
      <canvas id="t-chart" width="200" height="35" style="margin-top:6px"></canvas>
    </div>
    <div class="card csm">
      <div class="stat-label">Active Loans</div>
      <div class="stat-value" id="t-loans">‚Äî</div>
      <div class="stat-sub" id="t-loan-vol">‚Äî</div>
    </div>
    <div class="card csm">
      <div class="stat-label">Defaults / Repaid</div>
      <div class="stat-value"><span style="color:var(--red)" id="t-def-n">0</span> / <span style="color:var(--green)" id="t-rep-n">0</span></div>
    </div>
    <div class="card csm">
      <div class="stat-label">BTC Traded</div>
      <div class="stat-value" id="t-traded" style="color:var(--blue)">‚Äî</div>
      <div class="stat-sub" id="t-trade-vol">‚Äî</div>
    </div>
  </div>

  <div class="g2" style="margin-bottom:14px">
    <div class="card" style="max-height:300px;overflow:hidden;display:flex;flex-direction:column">
      <h3 style="margin-bottom:10px">Players</h3>
      <div style="overflow-y:auto;flex:1" id="t-player-list"></div>
    </div>
    <div class="card" style="max-height:300px;overflow:hidden;display:flex;flex-direction:column">
      <h3 style="margin-bottom:10px">Event Log</h3>
      <div style="overflow-y:auto;flex:1" id="t-log"></div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin-bottom:10px">Active Loans</h3>
    <div id="t-loans-list" style="font-family:var(--mono);font-size:11px;color:var(--muted2)">No active loans.</div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê PLAYER (unified) ‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-player">
  <div class="ticker" style="margin:-20px -20px 16px -20px">
    <span>BTC: <span id="p-tick-price" style="color:var(--gold)">‚Äî</span></span>
    <span>Day: <span id="p-tick-day">0</span></span>
    <span>You: <span id="p-tick-name" style="color:var(--text)">‚Äî</span></span>
    <span>Net Worth: <span id="p-tick-nw" style="color:var(--text)">‚Äî</span></span>
  </div>
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:8px">
    <div style="display:flex;align-items:center;gap:10px">
      <h2 id="player-display-name">Player</h2>
      <span class="badge bt2">Trader</span>
      <span id="p-credit-badge" class="badge bp" style="display:none">Credit Unlocked</span>
    </div>
    <span id="p-day-badge" class="badge bb" style="font-size:12px">DAY 0</span>
  </div>

  <!-- Stats row -->
  <div class="g4" style="margin-bottom:14px">
    <div class="card csm"><div class="stat-label">Cash (USD)</div><div class="stat-value mono" id="p-cash" style="color:var(--green)">‚Äî</div><div class="stat-sub" id="p-cash-sub">Deployed: ‚Äî</div></div>
    <div class="card csm"><div class="stat-label">Free BTC</div><div class="stat-value mono" id="p-btc" style="color:var(--gold)">‚Äî</div><div class="stat-sub" id="p-btc-usd">‚âà ‚Äî</div></div>
    <div class="card csm"><div class="stat-label">Locked Collateral</div><div class="stat-value mono" id="p-coll" style="color:var(--orange)">‚Äî</div><div class="stat-sub" id="p-coll-usd">‚âà ‚Äî</div></div>
    <div class="card csm"><div class="stat-label">Net Worth</div><div class="stat-value mono" id="p-networth">‚Äî</div><canvas id="p-chart" width="180" height="28" style="margin-top:5px"></canvas></div>
  </div>

  <!-- Credit / loan history bar -->
  <div class="card" style="margin-bottom:14px;padding:12px">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
      <div style="display:flex;gap:20px;align-items:center">
        <div><div class="stat-label">œÑ-Credit</div><div style="font-family:var(--mono);font-size:16px;color:var(--green)" id="p-tau-count">0/2</div></div>
        <div><div class="stat-label">Defaults</div><div style="font-family:var(--mono);font-size:16px;color:var(--red)" id="p-default-count">0</div></div>
        <div><div class="stat-label">Loans Lent</div><div style="font-family:var(--mono);font-size:16px;color:var(--blue)" id="p-lent-count">0</div></div>
        <div><div class="stat-label">Loans Borrowed</div><div style="font-family:var(--mono);font-size:16px;color:var(--purple)" id="p-borrow-count">0</div></div>
        <div><div class="stat-label">Interest Earned</div><div style="font-family:var(--mono);font-size:14px;color:var(--green)" id="p-interest-earned">$0</div></div>
      </div>
      <div id="p-credit-status" style="font-family:var(--mono);font-size:11px;color:var(--muted2);max-width:280px;text-align:right"></div>
    </div>
  </div>

  <!-- Main tabs -->
  <div class="section-tabs" style="flex-wrap:wrap">
    <button class="section-tab active" onclick="playerTab('lend')" id="ptab-lend">üí∞ Lend</button>
    <button class="section-tab" onclick="playerTab('borrow')" id="ptab-borrow">üìã Borrow</button>
    <button class="section-tab" onclick="playerTab('myloans')" id="ptab-myloans">My Loans <span id="p-loan-dot" style="color:var(--red);display:none">‚óè</span></button>
    <button class="section-tab" onclick="playerTab('market')" id="ptab-market">Open Market <span id="p-market-dot" style="display:none;color:var(--gold)">‚óè</span></button>
    <button class="section-tab" onclick="playerTab('trade')" id="ptab-trade">BTC Trade</button>
    <button class="section-tab" onclick="playerTab('history')" id="ptab-history">Player History</button>
  </div>

  <!-- ‚îÄ‚îÄ LEND tab ‚îÄ‚îÄ -->
  <div id="psec-lend">
    <div class="g2">
      <div class="card">
        <h3 style="margin-bottom:12px">Publish a Lending Offer</h3>
        <div style="margin-bottom:10px"><div style="font-size:10px;color:var(--muted2);margin-bottom:5px;font-family:var(--mono)">Interest Rate (% APR)</div><input class="inp" id="p-l-rate" type="number" value="12" min="1" max="60" step="1"/></div>
        <div style="margin-bottom:10px"><div style="font-size:10px;color:var(--muted2);margin-bottom:5px;font-family:var(--mono)">Max LTV (%)</div><input class="inp" id="p-l-ltv" type="number" value="40" min="10" max="100" step="5"/></div>
        <div style="margin-bottom:10px"><div style="font-size:10px;color:var(--muted2);margin-bottom:5px;font-family:var(--mono)">Max Loan Size (USD)</div><input class="inp" id="p-l-maxloan" type="number" value="30000" min="1000" step="1000"/></div>
        <div style="margin-bottom:14px"><div style="font-size:10px;color:var(--muted2);margin-bottom:5px;font-family:var(--mono)">Min œÑ-credit required</div><input class="inp" id="p-l-tau-req" type="number" value="0" min="0" max="10" step="1"/></div>
        <button class="btn btn-green btn-full" onclick="publishOffer()">Publish Offer</button>
        <div id="p-l-offer-status" style="font-size:10px;color:var(--muted2);text-align:center;margin-top:7px;font-family:var(--mono)"></div>
      </div>
      <div class="card" style="max-height:440px;overflow:hidden;display:flex;flex-direction:column">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <h3>My Incoming Requests (<span id="p-req-count">0</span>)</h3>
          <span class="tag blink" id="p-req-badge" style="display:none;color:var(--gold)">NEW</span>
        </div>
        <div style="overflow-y:auto;flex:1" id="p-requests-list"><p style="font-size:11px;color:var(--muted);text-align:center;padding:20px;font-family:var(--mono)">No pending requests.</p></div>
      </div>
    </div>
    <div class="card" style="margin-top:12px;max-height:340px;overflow:hidden;display:flex;flex-direction:column">
      <h3 style="margin-bottom:10px">My Active Loans Out (<span id="p-lent-active">0</span>)</h3>
      <div style="overflow-y:auto;flex:1" id="p-active-lent"><p style="font-size:11px;color:var(--muted);text-align:center;padding:16px;font-family:var(--mono)">No active loans out.</p></div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ BORROW tab ‚îÄ‚îÄ -->
  <div id="psec-borrow" style="display:none">
    <div class="g2" style="margin-bottom:12px">
      <div class="card">
        <h3 style="margin-bottom:12px">Post a Borrow Request</h3>
        <div style="margin-bottom:10px"><div style="font-size:10px;color:var(--muted2);margin-bottom:5px;font-family:var(--mono)">Amount (USD)</div><input class="inp" id="p-br-amount" type="number" placeholder="0" oninput="updateBorrowRequestPreview()"/></div>
        <div style="margin-bottom:10px"><div style="font-size:10px;color:var(--muted2);margin-bottom:5px;font-family:var(--mono)">Max rate (% APR)</div><input class="inp" id="p-br-maxrate" type="number" value="15" min="1" max="60" step="1"/></div>
        <div style="margin-bottom:10px"><div style="font-size:10px;color:var(--muted2);margin-bottom:5px;font-family:var(--mono)">Duration</div>
          <div style="display:flex;gap:5px" id="p-br-dur-btns">
            <button class="btn btn-surface btn-sm" onclick="setBRDur(7)" data-dur="7">7d</button>
            <button class="btn btn-surface btn-sm" onclick="setBRDur(14)" data-dur="14">14d</button>
            <button class="btn btn-gold btn-sm" onclick="setBRDur(30)" data-dur="30">30d</button>
            <button class="btn btn-surface btn-sm" onclick="setBRDur(60)" data-dur="60">60d</button>
            <button class="btn btn-surface btn-sm" onclick="setBRDur(90)" data-dur="90">90d</button>
          </div>
        </div>
        <div id="p-br-preview" style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:12px;font-family:var(--mono);font-size:11px;display:none"></div>
        <button class="btn btn-purple btn-full" onclick="postBorrowRequest()">Post to Open Market</button>
      </div>
      <div class="card">
        <h3 style="margin-bottom:10px">My Open Requests</h3>
        <div id="p-my-requests"><p style="font-size:11px;color:var(--muted);text-align:center;padding:20px;font-family:var(--mono)">No requests posted.</p></div>
      </div>
    </div>
    <div class="card" style="max-height:460px;overflow:hidden;display:flex;flex-direction:column">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <h3>Available Lending Offers (<span id="p-offer-count">0</span>)</h3>
        <span class="tag">Sorted by APR ‚Üë</span>
      </div>
      <div style="overflow-y:auto;flex:1" id="p-offers-list"><p style="font-size:11px;color:var(--muted);text-align:center;padding:20px;font-family:var(--mono)">No offers yet. Other players must publish lending offers first.</p></div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ MY LOANS tab ‚îÄ‚îÄ -->
  <div id="psec-myloans" style="display:none">
    <div class="g2">
      <div class="card" style="max-height:500px;overflow:hidden;display:flex;flex-direction:column">
        <h3 style="margin-bottom:10px">Loans I'm Borrowing (<span id="p-myborrow-count">0</span>)</h3>
        <div style="overflow-y:auto;flex:1" id="p-myborrow-list"><p style="font-size:11px;color:var(--muted);text-align:center;padding:20px;font-family:var(--mono)">No active loans.</p></div>
      </div>
      <div class="card" style="max-height:500px;overflow:hidden;display:flex;flex-direction:column">
        <h3 style="margin-bottom:10px">Loans I've Made (<span id="p-mylent-count">0</span>)</h3>
        <div style="overflow-y:auto;flex:1" id="p-mylent-list"><p style="font-size:11px;color:var(--muted);text-align:center;padding:20px;font-family:var(--mono)">No loans made.</p></div>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ OPEN MARKET tab ‚îÄ‚îÄ -->
  <div id="psec-market" style="display:none">
    <div class="card" style="max-height:560px;overflow:hidden;display:flex;flex-direction:column">
      <h3 style="margin-bottom:6px">Open Borrow Requests (from all players)</h3>
<div style="overflow-y:auto;flex:1" id="p-open-requests"><p style="font-size:11px;color:var(--muted);text-align:center;padding:20px;font-family:var(--mono)">No open requests.</p></div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ BTC TRADE tab ‚îÄ‚îÄ -->
  <div id="psec-trade" style="display:none">
    <div class="g2">
      <div class="card">
        <h3 style="margin-bottom:12px">Trade BTC</h3>
        <div style="margin-bottom:10px"><div style="font-size:10px;color:var(--muted2);margin-bottom:5px;font-family:var(--mono)">Current Price</div><div style="font-family:var(--mono);font-size:18px;color:var(--gold)" id="p-trade-price">‚Äî</div></div>
        <div class="tabs" style="margin-bottom:12px">
          <button class="tab active" onclick="setTradeSide('player','buy')" id="p-trade-buy">BUY BTC</button>
          <button class="tab" onclick="setTradeSide('player','sell')" id="p-trade-sell">SELL BTC</button>
        </div>
        <div style="margin-bottom:10px"><div style="font-size:10px;color:var(--muted2);margin-bottom:5px;font-family:var(--mono)" id="p-trade-label">Amount (BTC)</div><input class="inp" id="p-trade-amt" type="number" placeholder="0.0000" step="0.0001" oninput="updateTradePreview('player')"/></div>
        <div style="display:flex;gap:5px;margin-bottom:12px" id="p-trade-pcts"></div>
        <div id="p-trade-preview" style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:12px;font-family:var(--mono);font-size:11px;display:none"></div>
        <button class="btn btn-gold btn-full" onclick="executeTrade('player')">Execute Trade</button>
      </div>
      <div class="card">
        <h3 style="margin-bottom:10px">Tips</h3>
        <div style="font-size:11px;color:var(--muted2);line-height:1.7;font-family:var(--mono)">
          <div style="margin-bottom:6px"><span style="color:var(--green)">Lend:</span> Publish an offer ‚Üí players request loans ‚Üí approve/reject.</div>
          <div style="margin-bottom:6px"><span style="color:var(--gold)">Borrow:</span> Borrow cash ‚Üí buy BTC ‚Üí post collateral ‚Üí borrow more.</div>
          <div style="margin-bottom:6px"><span style="color:var(--purple)">œÑ-credit:</span> After œÑ repaid loans, unlock undercollateral (100% LTV, no liquidation).</div>
          <div><span style="color:var(--red)">Risk:</span> Leverage amplifies losses ‚Äî a crash cascades.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ PLAYER HISTORY tab ‚îÄ‚îÄ -->
  <div id="psec-history" style="display:none">
    <div class="card">
      
<div id="p-player-history"></div>
    </div>
  </div>
</div>


<!-- ‚ïê‚ïê‚ïê BORROW MODAL (from lender offer) ‚ïê‚ïê‚ïê -->
<div class="modal-bg" id="borrow-modal" style="display:none">
  <div class="modal">
    <h2 style="margin-bottom:4px">Request Loan</h2>
    <p style="font-size:11px;color:var(--muted2);margin-bottom:18px;font-family:var(--mono)" id="bm-lender-info">From: ‚Äî</p>
    <div style="margin-bottom:12px">
      <div style="font-size:10px;color:var(--muted2);margin-bottom:5px;font-family:var(--mono)">Duration</div>
      <div style="display:flex;gap:5px;flex-wrap:wrap" id="bm-dur-btns">
        <button class="btn btn-surface btn-sm" onclick="setBorrowDur(7)" data-dur="7">7d</button>
        <button class="btn btn-surface btn-sm" onclick="setBorrowDur(14)" data-dur="14">14d</button>
        <button class="btn btn-gold btn-sm" onclick="setBorrowDur(30)" data-dur="30">30d</button>
        <button class="btn btn-surface btn-sm" onclick="setBorrowDur(60)" data-dur="60">60d</button>
        <button class="btn btn-surface btn-sm" onclick="setBorrowDur(90)" data-dur="90">90d</button>
      </div>
    </div>
    <div style="margin-bottom:12px">
      <div style="font-size:10px;color:var(--muted2);margin-bottom:5px;font-family:var(--mono)">Amount (USD)</div>
      <input class="inp" id="bm-amount" type="number" placeholder="0" oninput="updateBorrowPreview()"/>
      <div style="display:flex;gap:5px;margin-top:6px" id="bm-pct-btns"></div>
    </div>
    <div id="bm-preview" style="background:var(--bg);border:1px solid var(--border);border-radius:9px;padding:12px;margin-bottom:14px;font-family:var(--mono);font-size:11px;display:none"></div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost" style="flex:1" onclick="closeBorrowModal()">Cancel</button>
      <button class="btn btn-gold" style="flex:1" onclick="submitBorrowRequest()">Send Request</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê REPAY MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-bg" id="repay-modal" style="display:none">
  <div class="modal">
    <h2 style="margin-bottom:4px">Repay Loan</h2>
    <p style="font-size:11px;color:var(--muted2);margin-bottom:18px;font-family:var(--mono)" id="rm-info">Loan #‚Äî</p>
    <div id="rm-details" style="background:var(--bg);border:1px solid var(--border);border-radius:9px;padding:12px;margin-bottom:14px;font-family:var(--mono);font-size:11px"></div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost" style="flex:1" onclick="closeRepayModal()">Cancel</button>
      <button class="btn btn-green" style="flex:1" onclick="confirmRepay()">Repay Now</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê FULFILL REQUEST MODAL (lender fulfills borrower's open request) ‚ïê‚ïê‚ïê -->
<div class="modal-bg" id="fulfill-modal" style="display:none">
  <div class="modal">
    <h2 style="margin-bottom:4px">Fulfill Loan Request</h2>
    <p style="font-size:11px;color:var(--muted2);margin-bottom:4px;font-family:var(--mono)" id="fm-borrower-info">Borrower: ‚Äî</p>
    <div id="fm-history" style="background:rgba(61,155,255,.08);border:1px solid rgba(61,155,255,.2);border-radius:8px;padding:10px;margin-bottom:14px;font-family:var(--mono);font-size:11px"></div>
    <div style="margin-bottom:10px"><div style="font-size:10px;color:var(--muted2);margin-bottom:5px;font-family:var(--mono)">Your Rate (% APR) ‚Äî Borrower max: <span id="fm-maxrate">‚Äî</span>%</div><input class="inp" id="fm-rate" type="number" min="1" max="60" step="1"/></div>
    <div style="margin-bottom:10px"><div style="font-size:10px;color:var(--muted2);margin-bottom:5px;font-family:var(--mono)">LTV (%) ‚Äî lower = safer for you</div><input class="inp" id="fm-ltv" type="number" min="10" max="95" step="5"/></div>
    <div id="fm-preview" style="background:var(--bg);border:1px solid var(--border);border-radius:9px;padding:12px;margin-bottom:14px;font-family:var(--mono);font-size:11px"></div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost" style="flex:1" onclick="closeFulfillModal()">Cancel</button>
      <button class="btn btn-green" style="flex:1" onclick="confirmFulfill()">Fulfill Loan</button>
    </div>
  </div>
</div>

</div><!-- /app -->

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FB_CONFIG = {
  apiKey: "AIzaSyBcBo3g8z5_SgIGMPtgsfD5SP2ukvTKbx8",
  authDomain: "uplend-6480b.firebaseapp.com",
  databaseURL: "https://uplend-6480b-default-rtdb.firebaseio.com",
  projectId: "uplend-6480b",
  storageBucket: "uplend-6480b.firebasestorage.app",
  messagingSenderId: "747535784160",
  appId: "1:747535784160:web:867d6e406552a488725885"
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let db=null, roomCode=null, myId=null, myName='', isTeacher=false;
let autoClockInterval=null, autoClockRunning=false;
let joinMode='join', selectedOffer=null, borrowDuration=30, brDuration=30, repayLoanId=null, fulfillReqId=null;
let playerTradeSide='buy';
let priceHistory=[65000], myNWHistory=[], gameData={}, offersData={}, loansData={}, playersData={}, walletsData={}, openRequestsData={};
let myWallet={}, gameSettings={};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const fUSD=n=>new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}).format(n);
const fBTC=n=>(+n).toFixed(4)+' ‚Çø';
const fPct=n=>(+n).toFixed(1)+'%';
const uid=()=>Math.random().toString(36).substr(2,9);
const roomId=()=>{const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';let r='';for(let i=0;i<5;i++)r+=c[Math.floor(Math.random()*c.length)];return r;};
function owed(loan,day){const d=Math.max(day-loan.originDay,1);const i=loan.amount*(loan.rate/100)*(d/365);return{interest:i,total:loan.amount+i};}
function el(id){return document.getElementById(id);}
function show(id){const e=el(id);if(e)e.style.display='';}
function hide(id){const e=el(id);if(e)e.style.display='none';}
function setText(id,v){const e=el(id);if(e)e.textContent=v;}
function simPrice(p){return Math.max(p*Math.exp(0.0002+(Math.random()-.5)*0.08),1000);}
function creditStatus(wallet, tau) {
  const lsd = wallet.loansSinceDefault || 0;
  const defs = wallet.defaults || 0;
  const inPunishment = wallet.inPunishment || false;
  if (inPunishment) return { color: 'var(--red)', text: `‚õî Default penalty: ${lsd}/${tau} overcollateralized loans completed ‚Äî credit suspended` };
  if (lsd >= tau) return { color: 'var(--green)', text: `‚úì ${lsd}/${tau} loans repaid ‚Äî UNDERCOLLATERALIZED UNLOCKED` };
  if (defs > 0) return { color: 'var(--orange)', text: `${lsd}/${tau} loans since last default ‚Äî rebuilding credit` };
  return { color: 'var(--gold)', text: `${lsd}/${tau} overcollateralized loans repaid ‚Äî building œÑ-credit` };
}
function canAccessUnder(wallet, tau) {
  return (wallet.loansSinceDefault||0) >= tau && !wallet.inPunishment;
}
const PAPER_PARAMS = {
  i:0.02, c:0.10, y:0.08, k:2.5, l:1.0,
  rho_bar:0.1177, r_max:0.2064, r_min:0.10,
  ltvOver:1/2.5, ltvUnder:1.0,
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('load',()=>{
  if(typeof firebase==='undefined'){el('loading-msg').textContent='Firebase failed to load. Check connection.';el('loading-msg').style.color='#ff3b5c';return;}
  try{
    firebase.initializeApp(FB_CONFIG);
    db=firebase.database();
    db.ref('.info/connected').once('value').then(()=>{
      el('loading-overlay').style.display='none';
      showScreen('screen-join');
    }).catch(e=>{el('loading-msg').textContent='Connection failed: '+e.message;el('loading-msg').style.color='#ff3b5c';});
  }catch(e){el('loading-msg').textContent='Firebase error: '+e.message;el('loading-msg').style.color='#ff3b5c';}
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));el(id).classList.add('active');}
function setJoinMode(m){joinMode=m;el('tab-join').classList.toggle('active',m==='join');el('tab-create').classList.toggle('active',m==='create');el('join-panel').style.display=m==='join'?'':'none';el('create-panel').style.display=m==='create'?'':'none';}
function showJoinError(msg){el('join-error').textContent=msg;show('join-error');setTimeout(()=>hide('join-error'),3500);}
function playerTab(t){
  ['lend','borrow','myloans','market','trade','history'].forEach(s=>{
    el('psec-'+s).style.display=s===t?'':'none';
    el('ptab-'+s).classList.toggle('active',s===t);
  });
  if(t==='history') renderPlayerHistory();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// JOIN / CREATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getPlayerName(){const n=el('player-name').value.trim();if(!n){showJoinError('Enter your name first.');return null;}return n;}

async function joinRoom(){
  const name=getPlayerName();if(!name)return;
  const code=el('room-code-input').value.trim().toUpperCase();
  if(!code){showJoinError('Enter a room code.');return;}
  const snap=await db.ref(`rooms/${code}`).once('value');
  if(!snap.exists()){showJoinError('Room not found.');return;}
  if(snap.val().status==='playing'){showJoinError('Game already started.');return;}
  myName=name;roomCode=code;myId=uid();isTeacher=false;
  await db.ref(`rooms/${code}/players/${myId}`).set({name,role:'player',online:true,joinedAt:Date.now()});
  listenLobby();showScreen('screen-lobby');el('lobby-room-code').textContent=code;
  el('student-lobby-wait').style.display='';el('teacher-lobby-controls').style.display='none';
}

async function createRoom(){
  const name=getPlayerName();if(!name)return;
  myName=name;roomCode=roomId();myId=uid();isTeacher=false;
  await db.ref(`rooms/${roomCode}`).set({status:'lobby',createdAt:Date.now(),settings:{startingCash:50000,btcPerPlayer:1.0,startPrice:65000,tau:2},game:{day:0,price:65000,priceHistory:[65000],totalDefaults:0,totalRepaid:0,totalBtcTraded:0,totalTradeVol:0,log:[]}});
  await db.ref(`rooms/${roomCode}/players/${myId}`).set({name,role:'player',online:true,joinedAt:Date.now()});
  listenLobby();showScreen('screen-lobby');el('lobby-room-code').textContent=roomCode;
  el('student-lobby-wait').style.display='';el('teacher-lobby-controls').style.display='none';
}

async function joinAsTeacher(){
  const name=el('player-name').value.trim()||'Teacher';
  myName=name;roomCode=roomId();myId='teacher';isTeacher=true;
  await db.ref(`rooms/${roomCode}`).set({status:'lobby',createdAt:Date.now(),settings:{startingCash:50000,btcPerPlayer:1.0,startPrice:65000,tau:2},game:{day:0,price:65000,priceHistory:[65000],totalDefaults:0,totalRepaid:0,totalBtcTraded:0,totalTradeVol:0,log:[]}});
  await db.ref(`rooms/${roomCode}/players/teacher`).set({name,role:'teacher',online:true,joinedAt:Date.now()});
  listenLobby();showScreen('screen-lobby');el('lobby-room-code').textContent=roomCode;
  el('teacher-lobby-controls').style.display='';el('student-lobby-wait').style.display='none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOBBY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function listenLobby(){
  db.ref(`rooms/${roomCode}/players`).on('value',snap=>{playersData=snap.val()||{};renderLobbyPlayers();});
  db.ref(`rooms/${roomCode}/status`).on('value',snap=>{if(snap.val()==='playing')loadAndEnterGame();});
}
function renderLobbyPlayers(){
  const players=Object.entries(playersData);
  el('player-count').textContent=players.length;
  el('player-list').innerHTML=players.map(([id,p])=>`<div class="player-row"><div style="display:flex;align-items:center;gap:8px"><span class="dot dot-green"></span><span style="font-weight:600">${p.name}</span>${id===myId?'<span class="tag">You</span>':''}</div><span class="badge ${p.role==='teacher'?'bt2':'bl'}">${p.role}</span></div>`).join('');
}
async function startGame(){
  const s={
    startingCash:parseFloat(el('setting-cash').value)||50000,
    btcPerPlayer:parseFloat(el('setting-btc').value)||1.0,
    startPrice:parseFloat(el('setting-price').value)||65000,
    tau:parseInt(el('setting-tau').value)||2,
    autoSpeed:parseInt(el('setting-speed').value)||0
  };
  await db.ref(`rooms/${roomCode}/settings`).set(s);
  const players=Object.entries(playersData).filter(([id])=>id!=='teacher');
  const updates={};
  updates[`rooms/${roomCode}/status`]='playing';
  players.forEach(([id,p])=>{
    updates[`rooms/${roomCode}/players/${id}/role`]='player';
    updates[`rooms/${roomCode}/wallets/${id}`]={
      cash:s.startingCash, btc:s.btcPerPlayer, role:'player', name:p.name,
      totalLent:0, totalInterest:0, totalBorrowed:0, totalRepaid:0,
      defaults:0, repaid:0, loansSinceDefault:0, inPunishment:false,
      nwHistory:[s.startingCash + s.btcPerPlayer*s.startPrice]
    };
  });
  await db.ref().update(updates);
}
async function loadAndEnterGame(){
  if(isTeacher){
    const ss=await db.ref(`rooms/${roomCode}/settings`).once('value');
    gameSettings=ss.val()||{};
    showScreen('screen-teacher');initTeacher();return;
  }
  const snap=await db.ref(`rooms/${roomCode}/wallets/${myId}`).once('value');
  if(!snap.exists()){
    // retry in case wallet not yet written
    setTimeout(loadAndEnterGame, 500); return;
  }
  const ss=await db.ref(`rooms/${roomCode}/settings`).once('value');
  gameSettings=ss.val()||{};
  showScreen('screen-player');
  initPlayer();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TEACHER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initTeacher(){
  el('t-room-code').textContent=roomCode;
  db.ref(`rooms/${roomCode}/game`).on('value',snap=>{gameData=snap.val()||{};renderTeacher();});
  db.ref(`rooms/${roomCode}/players`).on('value',snap=>{playersData=snap.val()||{};renderTeacherPlayers();});
  db.ref(`rooms/${roomCode}/loans`).on('value',snap=>{loansData=snap.val()||{};renderTeacherLoans();});
  // Auto-clock: start if speed was configured
  const speed=gameSettings.autoSpeed||0;
  if(speed>0){startAutoClock(speed);}
}
function startAutoClock(seconds){
  if(autoClockInterval) clearInterval(autoClockInterval);
  autoClockRunning=true;
  autoClockInterval=setInterval(()=>{ if(autoClockRunning) advanceDay(); }, seconds*1000);
  el('t-auto-btn').textContent='‚èπ Stop';
  el('t-auto-btn').style.background='var(--red)';
  el('t-auto-btn').style.color='#fff';
  el('t-auto-status').style.display='';
  el('t-auto-status').textContent='Auto: every '+seconds+'s';
}
function stopAutoClock(){
  if(autoClockInterval){clearInterval(autoClockInterval);autoClockInterval=null;}
  autoClockRunning=false;
  el('t-auto-btn').textContent='‚ñ∂ Auto';
  el('t-auto-btn').style.background='';
  el('t-auto-btn').style.color='';
  el('t-auto-status').style.display='none';
}
function toggleAutoClock(){
  if(autoClockRunning){stopAutoClock();}
  else{
    const speed=gameSettings.autoSpeed||5;
    startAutoClock(speed);
  }
}
function renderTeacher(){
  const price=gameData.price||65000, day=gameData.day||0, hist=gameData.priceHistory||[price];
  priceHistory=hist;
  const tauDisp=gameSettings.tau||2;
  if(el('t-tau-display')) el('t-tau-display').textContent=tauDisp;
  const prev=hist.length>1?hist[hist.length-2]:price;
  const chg=((price-prev)/prev*100).toFixed(2);
  setText('t-price',fUSD(price));setText('t-day-badge','DAY '+day);
  setText('t-tick-price',fUSD(price));setText('t-tick-day',day+'');
  el('t-price-chg').textContent=(price>=prev?'‚ñ≤ ':'‚ñº ')+chg+'%';
  el('t-price-chg').style.color=price>=prev?'var(--green)':'var(--red)';
  const defs=gameData.totalDefaults||0, reps=gameData.totalRepaid||0;
  setText('t-def-n',defs+'');setText('t-rep-n',reps+'');
  const allLoans=Object.values(loansData).filter(l=>l.status==='active');
  setText('t-loans',allLoans.length+'');
  const vol=allLoans.reduce((s,l)=>s+l.amount,0);
  setText('t-loan-vol','Volume: '+fUSD(vol));
  setText('t-tick-loans',allLoans.length+'');
  setText('t-tick-vol',fUSD(vol));
  setText('t-tick-dr',defs+'');setText('t-tick-rp',reps+'');
  const traded=gameData.totalBtcTraded||0, tradeVol=gameData.totalTradeVol||0;
  setText('t-traded',fBTC(traded));setText('t-trade-vol','Volume: '+fUSD(tradeVol));
  drawChart('t-chart',hist,200,35);
  const log=gameData.log||[];
  el('t-log').innerHTML=[...log].reverse().slice(0,60).map(e=>`<div class="log-entry log-${e.type||'info'}">[D${e.day}] ${e.msg}</div>`).join('');
}
function renderTeacherPlayers(){
  const players=Object.entries(playersData);
  setText('t-tick-players',players.length+'');
  el('t-player-list').innerHTML=players.map(([id,p])=>`<div class="player-row"><div style="display:flex;align-items:center;gap:7px"><span class="dot dot-green"></span><span style="font-size:12px;font-weight:600">${p.name}</span></div><span class="badge ${p.role==='teacher'?'bt2':'bl'}">${p.role}</span></div>`).join('');
}
function renderTeacherLoans(){
  const loans=Object.entries(loansData).filter(([,l])=>l.status==='active');
  if(!loans.length){el('t-loans-list').innerHTML='<p style="color:var(--muted);text-align:center;padding:10px;font-family:var(--mono);font-size:11px">No active loans.</p>';return;}
  const day=gameData.day||0, price=gameData.price||65000;
  el('t-loans-list').innerHTML=`<div style="display:grid;grid-template-columns:1.5fr 1.2fr 1.2fr 1fr 1fr 1fr 1fr;gap:6px;font-size:10px;color:var(--muted2);padding:4px 0;border-bottom:1px solid var(--border);margin-bottom:4px"><span>ID</span><span>Borrower</span><span>Lender</span><span>Type</span><span>Amount</span><span>Health</span><span>Days Left</span></div>`+
  loans.map(([id,l])=>{
    const o=owed(l,day);const isUnder=l.loanType==='undercollateralized';
    const h=isUnder?'N/A':(l.collateralBtc*price/o.total).toFixed(2)+'x';
    const hc=isUnder?'var(--purple)':parseFloat(h)>1.5?'var(--green)':parseFloat(h)>1.1?'var(--gold)':'var(--red)';
    const dr=Math.max((l.originDay+l.duration)-day,0);
    return`<div style="display:grid;grid-template-columns:1.5fr 1.2fr 1.2fr 1fr 1fr 1fr 1fr;gap:6px;font-size:10px;padding:4px 0;border-bottom:1px solid rgba(26,45,66,.3)"><span style="color:var(--muted2)">#${id.substr(0,5)}</span><span>${l.borrowerName}</span><span style="color:var(--green)">${l.lenderName}</span><span style="color:${isUnder?'var(--purple)':'var(--gold)'};font-size:9px">${isUnder?'UNDER':'OVER'}</span><span>${fUSD(l.amount)}</span><span style="color:${hc}">${h}</span><span style="color:${dr<=3?'var(--red)':'var(--muted2)'}">${dr}d</span></div>`;
  }).join('');
}
async function advanceDay(){
  const snap=await db.ref(`rooms/${roomCode}/game`).once('value');
  const game=snap.val()||{};
  const day=(game.day||0)+1, price=simPrice(game.price||65000);
  const hist=[...(game.priceHistory||[price]).slice(-60),price];
  const tau=(gameSettings.tau||2);
  const lSnap=await db.ref(`rooms/${roomCode}/loans`).once('value');const loans=lSnap.val()||{};
  const wSnap=await db.ref(`rooms/${roomCode}/wallets`).once('value');const wallets=wSnap.val()||{};
  let updates={}, newLog=[], totalDefaults=game.totalDefaults||0, totalRepaid=game.totalRepaid||0;
  for(const[lid,loan]of Object.entries(loans)){
    if(loan.status!=='active')continue;
    const matDay=loan.originDay+loan.duration;
    const bwBase=wallets[loan.borrowerId]||{};
    const bw=Object.assign({},bwBase,...Object.entries(updates).filter(([k])=>k.includes(`/wallets/${loan.borrowerId}/`)).map(([k,v])=>({[k.split('/').pop()]:v})));
    const lw=wallets[loan.lenderId]||{};
    const o=owed(loan,day);
    const isUnder=loan.loanType==='undercollateralized';
    const curLTV=loan.amount/(loan.collateralBtc*price);
    if(!isUnder && curLTV>(loan.ltvLimit||0.95)){
      updates[`rooms/${roomCode}/loans/${lid}/status`]='liquidated';
      updates[`rooms/${roomCode}/wallets/${loan.lenderId}/cash`]=(lw.cash||0)+loan.collateralBtc*price;
      updates[`rooms/${roomCode}/wallets/${loan.lenderId}/totalInterest`]=(lw.totalInterest||0)+(loan.collateralBtc*price-loan.amount);
      totalDefaults++;
      updates[`rooms/${roomCode}/wallets/${loan.borrowerId}/defaults`]=(bwBase.defaults||0)+1;
      updates[`rooms/${roomCode}/wallets/${loan.borrowerId}/loansSinceDefault`]=0;
      updates[`rooms/${roomCode}/wallets/${loan.borrowerId}/inPunishment`]=true;
      newLog.push({day,msg:`üí• LIQUIDATED (overcoll): ${loan.borrowerName}'s ${fUSD(loan.amount)} loan. œÑ RESET.`,type:'down'});
      continue;
    }
    if(day>=matDay){
      if((bw.cash||0)>=o.total){
        updates[`rooms/${roomCode}/loans/${lid}/status`]='repaid';
        updates[`rooms/${roomCode}/wallets/${loan.borrowerId}/cash`]=(bw.cash||0)-o.total;
        updates[`rooms/${roomCode}/wallets/${loan.borrowerId}/btc`]=(bw.btc||0)+loan.collateralBtc;
        updates[`rooms/${roomCode}/wallets/${loan.borrowerId}/repaid`]=(bwBase.repaid||0)+1;
        const newLSD=Math.min((bwBase.loansSinceDefault||0)+1,tau+10);
        updates[`rooms/${roomCode}/wallets/${loan.borrowerId}/loansSinceDefault`]=newLSD;
        if(bwBase.inPunishment&&newLSD>=tau) updates[`rooms/${roomCode}/wallets/${loan.borrowerId}/inPunishment`]=false;
        updates[`rooms/${roomCode}/wallets/${loan.lenderId}/cash`]=(lw.cash||0)+o.total;
        updates[`rooms/${roomCode}/wallets/${loan.lenderId}/totalInterest`]=(lw.totalInterest||0)+o.interest;
        updates[`rooms/${roomCode}/wallets/${loan.lenderId}/repaid`]=(lw.repaid||0)+1;
        totalRepaid++;
        newLog.push({day,msg:`‚úÖ REPAID ${isUnder?'[UNDER]':'[OVER]'}: ${loan.borrowerName}‚Üí${loan.lenderName} ${fUSD(o.total)} (+œÑ ${newLSD}/${tau})`,type:'up'});
        if(isUnder){
          const G=(PAPER_PARAMS.k-PAPER_PARAMS.l)*loan.amount*PAPER_PARAMS.y*(1+((price/(game.price||price))-1));
          if(G>0){updates[`rooms/${roomCode}/wallets/${loan.borrowerId}/cash`]=(bw.cash||0)-o.total+G;newLog.push({day,msg:`üí∞ G-YIELD +${fUSD(G)} to ${loan.borrowerName} (undercoll yield)`,type:'gold'});}
        }
      } else {
        updates[`rooms/${roomCode}/loans/${lid}/status`]='defaulted';
        updates[`rooms/${roomCode}/wallets/${loan.lenderId}/cash`]=(lw.cash||0)+loan.collateralBtc*price;
        updates[`rooms/${roomCode}/wallets/${loan.borrowerId}/defaults`]=(bwBase.defaults||0)+1;
        totalDefaults++;
        updates[`rooms/${roomCode}/wallets/${loan.borrowerId}/loansSinceDefault`]=0;
        updates[`rooms/${roomCode}/wallets/${loan.borrowerId}/inPunishment`]=true;
        newLog.push({day,msg:`‚ö†Ô∏è DEFAULT ${isUnder?'[UNDER]':'[OVER]'}: ${loan.borrowerName} can't repay ${fUSD(o.total)}. œÑ RESET.`,type:'down'});
      }
    }
  }
  const dir=price>=(game.price||65000)?'‚ñ≤':'‚ñº';
  const chg=((price-(game.price||65000))/(game.price||65000)*100).toFixed(2);
  newLog.unshift({day,msg:`Day ${day}: BTC ${fUSD(price)} ${dir}${chg}%`,type:price>=(game.price||65000)?'up':'down'});
  const prevLog=game.log||[];
  updates[`rooms/${roomCode}/game/day`]=day;
  updates[`rooms/${roomCode}/game/price`]=price;
  updates[`rooms/${roomCode}/game/priceHistory`]=hist;
  updates[`rooms/${roomCode}/game/totalDefaults`]=totalDefaults;
  updates[`rooms/${roomCode}/game/totalRepaid`]=totalRepaid;
  updates[`rooms/${roomCode}/game/log`]=[...prevLog.slice(-80),...newLog];
  await db.ref().update(updates);
}
async function triggerShock(type){
  const snap=await db.ref(`rooms/${roomCode}/game`).once('value');const game=snap.val()||{};
  const p=game.price||65000;
  const mults={crash:.75,pump:1.25,minibull:1.10,minibear:.90};
  const np=p*(mults[type]||1);const day=game.day||0;
  const hist=[...(game.priceHistory||[p]).slice(-60),np];
  const labels={crash:'üí• MARKET CRASH',pump:'üöÄ PRICE PUMP',minibull:'üìà BULL RUN',minibear:'üìâ BEARISH'};
  const prevLog=game.log||[];
  await db.ref(`rooms/${roomCode}/game`).update({price:np,priceHistory:hist,log:[...prevLog.slice(-80),{day,msg:`${labels[type]}: ${fUSD(p)} ‚Üí ${fUSD(np)}`,type:['pump','minibull'].includes(type)?'up':'down'}]});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UNIFIED PLAYER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initPlayer(){
  el('player-display-name').textContent=myName;
  db.ref(`rooms/${roomCode}/game`).on('value',snap=>{gameData=snap.val()||{};updatePlayerHeader();renderPlayerTradePcts();});
  db.ref(`rooms/${roomCode}/wallets/${myId}`).on('value',snap=>{myWallet=snap.val()||{};updatePlayerWallet();});
  db.ref(`rooms/${roomCode}/wallets`).on('value',snap=>{walletsData=snap.val()||{};});
  db.ref(`rooms/${roomCode}/offers`).on('value',snap=>{offersData=snap.val()||{};renderAvailableOffers();});
  db.ref(`rooms/${roomCode}/loans`).on('value',snap=>{loansData=snap.val()||{};renderIncomingRequests();renderMyBorrowedLoans();renderMyLentLoans();});
  db.ref(`rooms/${roomCode}/openRequests`).on('value',snap=>{openRequestsData=snap.val()||{};renderMyOpenRequests();renderOpenMarket();});
}

function updatePlayerHeader(){
  const day=gameData.day||0, price=gameData.price||65000;
  el('p-day-badge').textContent='DAY '+day;
  setText('p-tick-price',fUSD(price));setText('p-tick-day',day+'');setText('p-tick-name',myName);
  setText('p-trade-price',fUSD(price));
}

function updatePlayerWallet(){
  const price=gameData.price||65000, tau=gameSettings.tau||2;
  const btc=myWallet.btc||0, cash=myWallet.cash||0;
  const myBorrowedLoans=Object.values(loansData).filter(l=>l.borrowerId===myId&&l.status==='active');
  const myLentLoans=Object.values(loansData).filter(l=>l.lenderId===myId&&l.status==='active');
  const totalDebt=myBorrowedLoans.reduce((s,l)=>s+owed(l,gameData.day||0).total,0);
  const lockedBtc=myBorrowedLoans.reduce((s,l)=>s+l.collateralBtc,0);
  const deployed=myLentLoans.reduce((s,l)=>s+l.amount,0);
  const nw=btc*price+cash-totalDebt;
  setText('p-cash',fUSD(cash));
  setText('p-cash-sub','Deployed: '+fUSD(deployed));
  setText('p-btc',fBTC(btc));
  setText('p-btc-usd','‚âà '+fUSD(btc*price));
  setText('p-coll',fBTC(lockedBtc));
  setText('p-coll-usd','‚âà '+fUSD(lockedBtc*price));
  setText('p-networth',fUSD(nw));
  setText('p-tick-nw',fUSD(nw));
  const lsd=myWallet.loansSinceDefault||0, defs=myWallet.defaults||0;
  setText('p-tau-count',lsd+'/'+tau);
  setText('p-default-count',defs+'');
  setText('p-lent-count',myLentLoans.length+'');
  setText('p-borrow-count',myBorrowedLoans.length+'');
  setText('p-interest-earned',fUSD(myWallet.totalInterest||0));
  const cs=creditStatus(myWallet,tau);
  el('p-credit-status').textContent=cs.text;el('p-credit-status').style.color=cs.color;
  if(canAccessUnder(myWallet,tau)){show('p-credit-badge');}else{hide('p-credit-badge');}
  const loanDot=myBorrowedLoans.some(l=>owed(l,gameData.day||0).total>(myWallet.cash||0));
  loanDot?show('p-loan-dot'):hide('p-loan-dot');
  myNWHistory.push(nw);if(myNWHistory.length>60)myNWHistory.shift();
  drawChart('p-chart',myNWHistory.length>1?myNWHistory:[nw,nw],180,28);
}

// ‚îÄ‚îÄ‚îÄ LEND TAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function publishOffer(){
  const rate=parseFloat(el('p-l-rate').value)||12;
  const ltv=parseFloat(el('p-l-ltv').value)||40;
  const maxLoan=parseFloat(el('p-l-maxloan').value)||30000;
  const tauReq=parseInt(el('p-l-tau-req').value)||0;
  await db.ref(`rooms/${roomCode}/offers/${myId}`).set({lenderId:myId,lenderName:myName,rate,ltv,maxLoan,tauReq,updatedAt:Date.now(),active:true});
  el('p-l-offer-status').textContent='‚úì Offer published';setTimeout(()=>el('p-l-offer-status').textContent='',2000);
}

function renderIncomingRequests(){
  const reqs=Object.entries(loansData).filter(([,l])=>l.lenderId===myId&&l.status==='pending');
  setText('p-req-count',reqs.length+'');
  reqs.length?show('p-req-badge'):hide('p-req-badge');
  if(!reqs.length){el('p-requests-list').innerHTML='<p style="font-size:11px;color:var(--muted);text-align:center;padding:20px;font-family:var(--mono)">No pending requests.</p>';return;}
  const day=gameData.day||0, price=gameData.price||65000, tau=gameSettings.tau||2;
  el('p-requests-list').innerHTML=reqs.map(([lid,l])=>{
    const bw=walletsData[l.borrowerId]||{};
    const lsd=bw.loansSinceDefault||0, defs=bw.defaults||0;
    const creditOk=canAccessUnder(bw,tau);
    const collVal=l.collateralBtc*price, ltvCur=(l.amount/collVal*100).toFixed(1);
    const rateOk=l.rate<=PAPER_PARAMS.r_max*100;
    return`<div class="req-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:7px">
        <span style="font-weight:700;font-size:13px">${l.borrowerName}</span>
        <span class="badge ${creditOk?'bp':'bb'}">${creditOk?'Credit Unlocked':lsd+'/'+tau+' œÑ'}</span>
      </div>
      <div style="background:var(--bg);border-radius:7px;padding:8px;margin-bottom:8px;font-family:var(--mono);font-size:10px;color:var(--muted2)">
        œÑ-credit: ${lsd}/${tau} ¬∑ Defaults: ${defs} ¬∑ Rate: ${l.rate}% ${rateOk?'‚úì':'‚ö†Ô∏è >'+(PAPER_PARAMS.r_max*100).toFixed(1)+'% r_max'}
      </div>
      <div class="g2" style="font-family:var(--mono);font-size:11px;gap:5px;margin-bottom:8px">
        <div><span style="color:var(--muted2)">Amount: </span>${fUSD(l.amount)}</div>
        <div><span style="color:var(--muted2)">Duration: </span>${l.duration}d</div>
        <div><span style="color:var(--muted2)">Collateral: </span>${fBTC(l.collateralBtc)}</div>
        <div><span style="color:var(--muted2)">LTV: </span>${ltvCur}%</div>
      </div>
      <div style="display:flex;gap:7px">
        <button class="btn btn-green btn-sm" style="flex:1" onclick="respondLoan('${lid}','approve')">Approve</button>
        <button class="btn btn-red btn-sm" style="flex:1" onclick="respondLoan('${lid}','reject')">Reject</button>
      </div>
    </div>`;
  }).join('');
}

function renderMyLentLoans(){
  const loans=Object.entries(loansData).filter(([,l])=>l.lenderId===myId&&l.status==='active');
  setText('p-lent-active',loans.length+'');
  setText('p-mylent-count',Object.entries(loansData).filter(([,l])=>l.lenderId===myId).length+'');
  if(!loans.length){el('p-active-lent').innerHTML='<p style="font-size:11px;color:var(--muted);text-align:center;padding:16px;font-family:var(--mono)">No active loans out.</p>';}
  const day=gameData.day||0, price=gameData.price||65000;
  const activeHtml=loans.map(([lid,l])=>{
    const o=owed(l,day), h=(l.collateralBtc*price)/o.total, dr=Math.max((l.originDay+l.duration)-day,0);
    const hc=h>1.5?'var(--green)':h>1.1?'var(--gold)':'var(--red)';
    return`<div class="loan-card ${dr<=3?'urgent':dr<=7?'warning':''}">
      <div style="display:flex;justify-content:space-between;margin-bottom:6px"><span style="font-weight:700">‚Üí ${l.borrowerName}</span><span style="font-family:var(--mono);font-size:11px;color:${dr<=3?'var(--red)':'var(--muted2)'}">${dr}d left</span></div>
      <div class="g2" style="font-family:var(--mono);font-size:11px;gap:4px">
        <div><span style="color:var(--muted2)">Principal: </span>${fUSD(l.amount)}</div>
        <div><span style="color:var(--muted2)">Owed: </span><span style="color:var(--orange)">${fUSD(o.total)}</span></div>
        <div><span style="color:var(--muted2)">Collateral: </span>${fBTC(l.collateralBtc)}</div>
        <div><span style="color:var(--muted2)">Health: </span><span style="color:${hc}">${h.toFixed(2)}x</span></div>
      </div>
      <div class="hbar" style="margin-top:8px"><div class="hbar-fill" style="width:${Math.min(h/2*100,100)}%;background:${hc}"></div></div>
    </div>`;
  }).join('');
  if(loans.length) el('p-active-lent').innerHTML=activeHtml;

  // also fill the My Loans tab lent list (all statuses)
  const allLent=Object.entries(loansData).filter(([,l])=>l.lenderId===myId);
  el('p-mylent-list').innerHTML=allLent.length?allLent.map(([lid,l])=>{
    const statusColor=l.status==='active'?'var(--green)':l.status==='repaid'?'var(--muted2)':l.status==='defaulted'?'var(--red)':'var(--muted)';
    const o=owed(l,day);
    return`<div class="loan-card ${l.status==='active'&&Math.max((l.originDay+l.duration)-day,0)<=3?'urgent':''}">
      <div style="display:flex;justify-content:space-between;margin-bottom:4px">
        <span style="font-weight:700">‚Üí ${l.borrowerName}</span>
        <span class="badge" style="background:rgba(0,0,0,.2);color:${statusColor}">${l.status}</span>
      </div>
      <div style="font-family:var(--mono);font-size:11px;color:var(--muted2)">${fUSD(l.amount)} @ ${l.rate}% ¬∑ ${l.duration}d ¬∑ Earned: ${fUSD(l.status==='active'?o.interest:(myWallet.totalInterest||0))}</div>
    </div>`;
  }).join(''):'<p style="font-size:11px;color:var(--muted);text-align:center;padding:20px;font-family:var(--mono)">No loans made yet.</p>';
}

async function respondLoan(loanId,decision){
  const loan=loansData[loanId];if(!loan)return;
  if(decision==='approve'){
    const lwSnap=await db.ref(`rooms/${roomCode}/wallets/${myId}`).once('value');const lw=lwSnap.val()||{};
    const bwSnap=await db.ref(`rooms/${roomCode}/wallets/${loan.borrowerId}`).once('value');const bw=bwSnap.val()||{};
    if((lw.cash||0)<loan.amount){alert('Insufficient funds!');return;}
    const tau=gameSettings.tau||2;
    const isUnderApprove=canAccessUnder(walletsData[loan.borrowerId]||{},tau)&&(loan.ltv||0)>=PAPER_PARAMS.ltvUnder*0.95;
    await db.ref().update({
      [`rooms/${roomCode}/loans/${loanId}/status`]:'active',
      [`rooms/${roomCode}/loans/${loanId}/loanType`]:isUnderApprove?'undercollateralized':'overcollateralized',
      [`rooms/${roomCode}/wallets/${myId}/cash`]:(lw.cash||0)-loan.amount,
      [`rooms/${roomCode}/wallets/${myId}/totalLent`]:(lw.totalLent||0)+loan.amount,
      [`rooms/${roomCode}/wallets/${loan.borrowerId}/cash`]:(bw.cash||0)+loan.amount,
    });
    addLog(`${myName} approved ${loan.borrowerName}'s loan for ${fUSD(loan.amount)}`,'up');
  } else {
    await db.ref(`rooms/${roomCode}/loans/${loanId}/status`).set('rejected');
    addLog(`${myName} rejected ${loan.borrowerName}'s request`,'warn');
  }
}

// ‚îÄ‚îÄ‚îÄ BORROW TAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAvailableOffers(){
  const offers=Object.entries(offersData).filter(([lid,o])=>o.active&&lid!==myId);
  setText('p-offer-count',offers.length+'');
  if(!offers.length){el('p-offers-list').innerHTML='<p style="font-size:11px;color:var(--muted);text-align:center;padding:20px;font-family:var(--mono)">No offers yet. Other players must publish lending offers.</p>';return;}
  const tau=gameSettings.tau||2, lsd=myWallet.loansSinceDefault||0;
  offers.sort(([,a],[,b])=>a.rate-b.rate);
  el('p-offers-list').innerHTML=offers.map(([lid,o])=>{
    const meetsCredit=lsd>=(o.tauReq||0)&&!myWallet.inPunishment;
    const locked=!meetsCredit&&(o.tauReq||0)>0;
    const onclickAttr=locked?'':'openBorrowModal(\''+lid+'\')';
    const cardStyle=locked?' style="opacity:.5;cursor:default"':'';
    const lockMsg=locked?'<div style="font-size:10px;color:var(--red);font-family:var(--mono)">üîí Requires '+o.tauReq+' œÑ-credits ‚Äî you have '+lsd+'</div>':'<div style="font-size:10px;color:var(--blue)">Tap to request loan ‚Üí</div>';
    return`<div class="offer-card"${cardStyle} onclick="${onclickAttr}">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <span style="font-weight:700;font-size:13px">${o.lenderName}</span>
        <span style="font-family:var(--mono);font-size:17px;font-weight:600;color:var(--green)">${o.rate}% APR</span>
      </div>
      <div class="g2" style="font-family:var(--mono);font-size:11px;gap:4px;margin-bottom:6px">
        <div><span style="color:var(--muted2)">Max LTV: </span>${o.ltv}%</div>
        <div><span style="color:var(--muted2)">Max Loan: </span>${fUSD(o.maxLoan)}</div>
        <div><span style="color:var(--muted2)">Requires œÑ: </span>${o.tauReq||0} loans</div>
        <div><span style="color:var(--muted2)">Your œÑ: </span><span style="color:${meetsCredit?'var(--green)':'var(--orange)'}">${lsd}</span></div>
      </div>
      ${lockMsg}
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ‚îÄ MY LOANS TAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderMyBorrowedLoans(){
  const myLoans=Object.entries(loansData).filter(([,l])=>l.borrowerId===myId);
  const active=myLoans.filter(([,l])=>l.status==='active');
  setText('p-myborrow-count',active.length+'');
  if(!myLoans.length){el('p-myborrow-list').innerHTML='<p style="font-size:11px;color:var(--muted);text-align:center;padding:20px;font-family:var(--mono)">No loans yet.</p>';return;}
  const day=gameData.day||0, price=gameData.price||65000;
  el('p-myborrow-list').innerHTML=myLoans.map(([lid,l])=>{
    if(l.status==='pending')return`<div class="loan-card"><div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:12px">Pending ‚Üí <b>${l.lenderName}</b></span><span class="badge bb blink">Pending...</span></div></div>`;
    if(l.status==='rejected')return`<div class="loan-card" style="opacity:.5"><div style="display:flex;justify-content:space-between"><span style="font-size:12px">Rejected by <b>${l.lenderName}</b></span><span class="badge" style="background:rgba(255,59,92,.1);color:var(--red)">Rejected</span></div></div>`;
    if(l.status==='repaid')return`<div class="loan-card" style="opacity:.5"><div style="display:flex;justify-content:space-between"><span style="font-size:12px">Repaid to <b>${l.lenderName}</b> ${fUSD(l.amount)}</span><span class="badge bl">Repaid ‚úì</span></div></div>`;
    if(l.status==='defaulted'||l.status==='liquidated')return`<div class="loan-card urgent" style="opacity:.5"><div style="display:flex;justify-content:space-between"><span style="font-size:12px">From <b>${l.lenderName}</b> ${fUSD(l.amount)}</span><span class="badge" style="background:rgba(255,59,92,.1);color:var(--red)">${l.status}</span></div></div>`;
    if(l.status!=='active')return'';
    const isUnder=l.loanType==='undercollateralized';
    const o=owed(l,day), h=isUnder?null:(l.collateralBtc*price)/o.total, dr=Math.max((l.originDay+l.duration)-day,0);
    const hc=isUnder?'var(--purple)':h>1.5?'var(--green)':h>1.1?'var(--gold)':'var(--red)';
    const canRepay=(myWallet.cash||0)>=o.total;
    return`<div class="loan-card ${isUnder?'':''}${!isUnder&&dr<=3?'urgent':!isUnder&&dr<=7?'warning':''}" style="${isUnder?'border-color:rgba(155,109,255,.4);':''}">
      <div style="display:flex;justify-content:space-between;margin-bottom:6px">
        <div style="display:flex;gap:6px;align-items:center"><span style="font-weight:700">‚Üê ${l.lenderName}</span><span class="badge ${isUnder?'bp':'bb'}" style="font-size:9px">${isUnder?'UNDER':'OVER'}</span></div>
        <span style="font-family:var(--mono);font-size:11px;color:${dr<=3?'var(--red)':'var(--muted2)'}">${dr}d left</span>
      </div>
      <div class="g2" style="font-family:var(--mono);font-size:11px;gap:4px;margin-bottom:8px">
        <div><span style="color:var(--muted2)">Principal: </span>${fUSD(l.amount)}</div>
        <div><span style="color:var(--muted2)">Owed: </span><span style="color:var(--orange)">${fUSD(o.total)}</span></div>
        <div><span style="color:var(--muted2)">Collateral: </span>${fBTC(l.collateralBtc)}</div>
        <div><span style="color:var(--muted2)">Health: </span><span style="color:${hc}">${isUnder?'No liq ‚úì':h.toFixed(2)+'x'}</span></div>
      </div>
      ${!isUnder?'<div class="hbar"><div class="hbar-fill" style="width:'+Math.min((h||0)/2*100,100)+'%;background:'+hc+'"></div></div>':''}
      <div style="margin-top:8px">
        <button class="btn btn-green btn-sm" style="width:100%" onclick="openRepayModal('${lid}')">${canRepay?'Repay Loan':'Repay (need more cash)'}</button>
      </div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ‚îÄ OPEN MARKET TAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderOpenMarket(){
  const reqs=Object.entries(openRequestsData).filter(([,r])=>r.status==='open'&&r.borrowerId!==myId);
  const hasNew=reqs.length>0;
  hasNew?show('p-market-dot'):hide('p-market-dot');
  if(!reqs.length){el('p-open-requests').innerHTML='<p style="font-size:11px;color:var(--muted);text-align:center;padding:20px;font-family:var(--mono)">No open requests.</p>';return;}
  const tau=gameSettings.tau||2;
  el('p-open-requests').innerHTML=reqs.map(([rid,r])=>{
    const bw=walletsData[r.borrowerId]||{};
    const lsd=bw.loansSinceDefault||0;
    const creditOk=canAccessUnder(bw,tau);
    return`<div class="offer-card" onclick="openFulfillModal('${rid}')">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <span style="font-weight:700">${r.borrowerName}</span>
        <span class="badge ${creditOk?'bp':'bb'}">${creditOk?'Credit Unlocked':lsd+'/'+tau+' œÑ'}</span>
      </div>
      <div class="g2" style="font-family:var(--mono);font-size:11px;gap:4px">
        <div><span style="color:var(--muted2)">Wants: </span>${fUSD(r.amount)}</div>
        <div><span style="color:var(--muted2)">Max rate: </span><span style="color:var(--gold)">${r.maxRate}% APR</span></div>
        <div><span style="color:var(--muted2)">Duration: </span>${r.duration}d</div>
        <div><span style="color:var(--muted2)">œÑ-credit: </span>${lsd}/${tau}</div>
      </div>
      <div style="margin-top:8px;font-size:10px;color:var(--blue)">Click to set terms and fulfill ‚Üí</div>
    </div>`;
  }).join('');
}

function renderMyOpenRequests(){
  const myReqs=Object.entries(openRequestsData).filter(([,r])=>r.borrowerId===myId);
  el('p-my-requests').innerHTML=myReqs.length?myReqs.map(([rid,r])=>`<div class="loan-card">
    <div style="display:flex;justify-content:space-between;margin-bottom:5px">
      <span style="font-weight:700">${fUSD(r.amount)} ¬∑ ${r.duration}d</span>
      <span class="badge ${r.status==='open'?'bb':r.status==='fulfilled'?'bl':''}" ${r.status==='cancelled'?'style="background:rgba(255,59,92,.1);color:var(--red)"':''}>${r.status}</span>
    </div>
    <div style="font-family:var(--mono);font-size:11px;color:var(--muted2)">Max rate: ${r.maxRate}% APR ¬∑ Posted Day ${r.postedDay}</div>
    ${r.status==='open'?'<button class="btn btn-red btn-xs" style="margin-top:8px" onclick="cancelBorrowRequest(\''+rid+'\')">Cancel</button>':''}
  </div>`).join(''):'<p style="font-size:11px;color:var(--muted);text-align:center;padding:20px;font-family:var(--mono)">No requests posted.</p>';
}

// ‚îÄ‚îÄ‚îÄ PLAYER HISTORY TAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderPlayerHistory(){
  const players=Object.entries(walletsData).filter(([id])=>id!=='teacher');
  const tau=gameSettings.tau||2;
  if(!players.length){el('p-player-history').innerHTML='<p style="font-size:11px;color:var(--muted);text-align:center;padding:20px;font-family:var(--mono)">No players yet.</p>';return;}
  el('p-player-history').innerHTML=`<div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr 1fr 2fr;gap:8px;font-size:10px;color:var(--muted);padding:6px 10px;border-bottom:1px solid var(--border);font-family:var(--mono)"><span>Name</span><span>œÑ-Credit</span><span>Defaults</span><span>Status</span><span>BTC</span><span>Net Worth</span><span>Suggested terms</span></div>`+
  players.map(([id,w])=>{
    const lsd=w.loansSinceDefault||0, defs=w.defaults||0;
    const creditOk=canAccessUnder(w,tau);
    const price=gameData.price||65000;
    const nw=(w.cash||0)+(w.btc||0)*price;
    const suggestRate=creditOk?`${(PAPER_PARAMS.c*100).toFixed(0)}‚Äì${(PAPER_PARAMS.r_max*100).toFixed(1)}% APR`:'c=10% [overcoll only]';
    const suggestLTV=creditOk?'up to 100% (no liq)':'max 40% (k=2.5)';
    const isMe=id===myId;
    return`<div class="history-row" style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr 1fr 1fr 2fr;gap:8px;${isMe?'background:rgba(61,155,255,.08);':''}">
      <span style="font-weight:600">${w.name}${isMe?' (you)':''}${w.inPunishment?' ‚õî':''}</span>
      <span style="color:var(--green)">${lsd}/${tau}</span>
      <span style="color:${defs>0?'var(--red)':'var(--muted2)'}">${defs}</span>
      <span class="badge ${creditOk?'bp':'bb'}" style="font-size:9px">${creditOk?'Credit OK':lsd+'/'+tau}</span>
      <span style="color:var(--gold)">${fBTC(w.btc||0)}</span>
      <span style="color:var(--text)">${fUSD(nw)}</span>
      <span style="color:var(--muted2);font-size:10px">${suggestRate} ¬∑ ${suggestLTV}</span>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ‚îÄ BORROW REQUEST (post to market) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let brDur=30;
function setBRDur(d){
  brDur=d;
  document.querySelectorAll('#p-br-dur-btns button').forEach(btn=>{const a=parseInt(btn.dataset.dur)===d;btn.className=a?'btn btn-gold btn-sm':'btn btn-surface btn-sm';});
  updateBorrowRequestPreview();
}
function updateBorrowRequestPreview(){
  const amt=parseFloat(el('p-br-amount').value), maxRate=parseFloat(el('p-br-maxrate').value)||15;
  if(!amt||amt<=0){el('p-br-preview').style.display='none';return;}
  el('p-br-preview').style.display='';
  el('p-br-preview').innerHTML=`<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--muted2)">Requesting</span><span>${fUSD(amt)}</span></div><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--muted2)">Duration</span><span>${brDur}d</span></div><div style="display:flex;justify-content:space-between"><span style="color:var(--muted2)">Max rate</span><span style="color:var(--gold)">${maxRate}% APR</span></div>`;
}
async function postBorrowRequest(){
  const amt=parseFloat(el('p-br-amount').value), maxRate=parseFloat(el('p-br-maxrate').value)||15;
  if(!amt||amt<=0){alert('Enter an amount.');return;}
  const day=gameData.day||0;
  const reqId=uid();
  await db.ref(`rooms/${roomCode}/openRequests/${reqId}`).set({borrowerId:myId,borrowerName:myName,amount:amt,maxRate,duration:brDur,postedDay:day,status:'open',createdAt:Date.now()});
  addLog(`${myName} posted borrow request: ${fUSD(amt)} @ max ${maxRate}% APR`,'purple');
  el('p-br-amount').value='';el('p-br-preview').style.display='none';
}
async function cancelBorrowRequest(reqId){
  await db.ref(`rooms/${roomCode}/openRequests/${reqId}/status`).set('cancelled');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BORROW MODAL (from lender offer)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openBorrowModal(lenderId){
  selectedOffer={id:lenderId,...offersData[lenderId]};
  el('bm-lender-info').textContent='From: '+selectedOffer.lenderName+' ¬∑ '+selectedOffer.rate+'% APR ¬∑ Max LTV '+selectedOffer.ltv+'%';
  el('bm-amount').value='';el('bm-preview').style.display='none';
  setBorrowDur(30);
  db.ref(`rooms/${roomCode}/wallets/${myId}`).once('value').then(snap=>{
    const w=snap.val()||{};const price=gameData.price||65000;
    const maxBorrow=Math.min((w.btc||0)*price*selectedOffer.ltv/100,selectedOffer.maxLoan);
    el('bm-pct-btns').innerHTML=[0.25,0.5,0.75,1].map(function(p){var v=(maxBorrow*p).toFixed(0);return '<button class="btn btn-surface btn-sm" style="flex:1" onclick="el(\'bm-amount\').value=\''+v+'\';updateBorrowPreview()">'+(p*100)+'%</button>';}).join('');
  });
  el('borrow-modal').style.display='flex';
}
function closeBorrowModal(){el('borrow-modal').style.display='none';}
function setBorrowDur(d){
  borrowDuration=d;
  document.querySelectorAll('#bm-dur-btns button').forEach(btn=>{const a=parseInt(btn.dataset.dur)===d;btn.className=a?'btn btn-gold btn-sm':'btn btn-surface btn-sm';});
  updateBorrowPreview();
}
function updateBorrowPreview(){
  if(!selectedOffer)return;
  const amt=parseFloat(el('bm-amount').value);
  if(!amt||amt<=0){el('bm-preview').style.display='none';return;}
  const price=gameData.price||65000, ltv=selectedOffer.ltv/100;
  const coll=amt/(price*ltv), interest=amt*(selectedOffer.rate/100)*(borrowDuration/365), liqPrice=amt/coll;
  el('bm-preview').style.display='';
  el('bm-preview').innerHTML=`<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--muted2)">Collateral needed</span><span>${fBTC(coll)}</span></div><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--muted2)">Liq. price</span><span style="color:var(--red)">${fUSD(liqPrice)}</span></div><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--muted2)">Interest (${borrowDuration}d)</span><span>${fUSD(interest)}</span></div><div style="display:flex;justify-content:space-between"><span style="color:var(--muted2)">Total to repay</span><span style="color:var(--orange)">${fUSD(amt+interest)}</span></div>`;
}
async function submitBorrowRequest(){
  const amt=parseFloat(el('bm-amount').value);
  if(!amt||amt<=0||!selectedOffer)return;
  const price=gameData.price||65000, day=gameData.day||0, ltv=selectedOffer.ltv/100, coll=amt/(price*ltv);
  const snap=await db.ref(`rooms/${roomCode}/wallets/${myId}`).once('value');const w=snap.val()||{};
  if((w.btc||0)<coll){alert('Not enough BTC for collateral!');return;}
  if(amt>selectedOffer.maxLoan){alert('Max loan size is '+fUSD(selectedOffer.maxLoan));return;}
  const loanId=uid();
  await db.ref().update({
    [`rooms/${roomCode}/loans/${loanId}`]:{borrowerId:myId,borrowerName:myName,lenderId:selectedOffer.id,lenderName:selectedOffer.lenderName,amount:amt,collateralBtc:coll,rate:selectedOffer.rate,ltv,ltvLimit:ltv*1.1,loanType:ltv>=PAPER_PARAMS.ltvUnder*0.95?'undercollateralized':'overcollateralized',duration:borrowDuration,originDay:day,status:'pending',requestedAt:Date.now()},
    [`rooms/${roomCode}/wallets/${myId}/btc`]:(w.btc||0)-coll,
  });
  addLog(`${myName} requested ${fUSD(amt)} from ${selectedOffer.lenderName}`,'gold');
  closeBorrowModal();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FULFILL MODAL (any player fulfills open request as lender)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openFulfillModal(reqId){
  fulfillReqId=reqId;
  const req=openRequestsData[reqId];if(!req)return;
  const bw=walletsData[req.borrowerId]||{};
  const lsd=bw.loansSinceDefault||0, defs=bw.defaults||0, tau=gameSettings.tau||2;
  const creditOk=canAccessUnder(bw,tau);
  el('fm-borrower-info').textContent='Borrower: '+req.borrowerName+' ¬∑ Wants '+fUSD(req.amount)+' for '+req.duration+'d';
  el('fm-maxrate').textContent=req.maxRate;
  el('fm-rate').value=creditOk?Math.min(req.maxRate,(PAPER_PARAMS.r_max*100).toFixed(1)):Math.min(req.maxRate,20);
  el('fm-ltv').value=creditOk?95:Math.round(PAPER_PARAMS.ltvOver*100);
  el('fm-history').innerHTML='<div style="margin-bottom:4px;color:var(--blue)">Borrower œÑ-History</div><div>œÑ-credit: <span style="color:var(--green)">'+lsd+'/'+tau+'</span> ¬∑ Defaults: <span style="color:'+(defs>0?'var(--red)':'var(--muted2)')+'">'+defs+'</span></div><div style="margin-top:4px;color:'+(creditOk?'var(--green)':'var(--gold)')+';">'+(creditOk?'‚úì Eligible for undercollateralized terms':'‚è≥ Must complete '+tau+' overcollateralized loans first')+'</div>';
  updateFulfillPreview();
  el('fm-rate').oninput=updateFulfillPreview;el('fm-ltv').oninput=updateFulfillPreview;
  el('fulfill-modal').style.display='flex';
}
function updateFulfillPreview(){
  const req=openRequestsData[fulfillReqId];if(!req)return;
  const rate=parseFloat(el('fm-rate').value)||12, ltv=parseFloat(el('fm-ltv').value)||50;
  const price=gameData.price||65000;
  const tau=gameSettings.tau||2;
  const bw=walletsData[req.borrowerId]||{};
  const creditOk=canAccessUnder(bw,tau);
  const isUnder=creditOk&&ltv>=95;
  const coll=req.amount/(price*(ltv/100));
  const interest=req.amount*(rate/100)*(req.duration/365);
  const liqPrice=req.amount/coll;
  const rateWarn=rate>PAPER_PARAMS.r_max*100?'<div style="color:var(--red);font-size:10px;margin-bottom:4px">‚ö†Ô∏è '+rate+'% > r_max=20.64% ‚Äî borrower may default!</div>':'';
  const typeTag=isUnder?'<div style="color:var(--purple);font-size:10px;margin-bottom:4px">üìã Undercollateralized loan ‚Äî no early liquidation</div>':'<div style="color:var(--gold);font-size:10px;margin-bottom:4px">üìã Overcollateralized</div>';
  el('fm-preview').innerHTML=typeTag+rateWarn+'<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--muted2)">Collateral required</span><span>'+fBTC(coll)+'</span></div>'+(isUnder?'<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--muted2)">Liquidation</span><span style="color:var(--green)">NONE ‚úì</span></div>':'<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--muted2)">Liq. price</span><span style="color:var(--red)">'+fUSD(liqPrice)+'</span></div>')+'<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--muted2)">Your interest ('+req.duration+'d)</span><span style="color:var(--green)">'+fUSD(interest)+'</span></div><div style="display:flex;justify-content:space-between"><span style="color:var(--muted2)">Borrower repays</span><span style="color:var(--orange)">'+fUSD(req.amount+interest)+'</span></div>';
}
function closeFulfillModal(){el('fulfill-modal').style.display='none';}
async function confirmFulfill(){
  const req=openRequestsData[fulfillReqId];if(!req)return;
  const rate=parseFloat(el('fm-rate').value)||12, ltv=parseFloat(el('fm-ltv').value)||50;
  if(rate>req.maxRate){alert('Borrower\'s max rate is '+req.maxRate+'%. Your rate is too high.');return;}
  const price=gameData.price||65000, day=gameData.day||0;
  const coll=req.amount/(price*(ltv/100));
  const lw=await db.ref(`rooms/${roomCode}/wallets/${myId}`).once('value').then(s=>s.val()||{});
  const bw=await db.ref(`rooms/${roomCode}/wallets/${req.borrowerId}`).once('value').then(s=>s.val()||{});
  if((lw.cash||0)<req.amount){alert('Insufficient funds!');return;}
  if((bw.btc||0)<coll){alert('Borrower doesn\'t have enough BTC (need '+fBTC(coll)+')');return;}
  const tau=gameSettings.tau||2;
  const isUnder=canAccessUnder(bw,tau)&&ltv>=(PAPER_PARAMS.ltvUnder*100-5);
  if(isUnder&&rate>PAPER_PARAMS.r_max*100){
    if(!confirm('Rate '+rate+'% exceeds paper r_max=20.64%. Borrower may strategically default. Continue?'))return;
  }
  const loanId=uid();
  await db.ref().update({
    [`rooms/${roomCode}/loans/${loanId}`]:{borrowerId:req.borrowerId,borrowerName:req.borrowerName,lenderId:myId,lenderName:myName,amount:req.amount,collateralBtc:coll,rate,ltv:ltv/100,ltvLimit:(ltv/100)*1.1,loanType:isUnder?'undercollateralized':'overcollateralized',duration:req.duration,originDay:day,status:'active',requestedAt:Date.now()},
    [`rooms/${roomCode}/wallets/${myId}/cash`]:(lw.cash||0)-req.amount,
    [`rooms/${roomCode}/wallets/${myId}/totalLent`]:(lw.totalLent||0)+req.amount,
    [`rooms/${roomCode}/wallets/${req.borrowerId}/cash`]:(bw.cash||0)+req.amount,
    [`rooms/${roomCode}/wallets/${req.borrowerId}/btc`]:(bw.btc||0)-coll,
    [`rooms/${roomCode}/openRequests/${fulfillReqId}/status`]:'fulfilled',
  });
  addLog(`${myName} fulfilled ${req.borrowerName}'s request: ${fUSD(req.amount)} @ ${rate}% [${isUnder?'UNDER':'over'}]`,'up');
  closeFulfillModal();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REPAY MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openRepayModal(loanId){
  repayLoanId=loanId;const loan=loansData[loanId];if(!loan)return;
  const day=gameData.day||0, o=owed(loan,day);
  el('rm-info').textContent='Loan from '+loan.lenderName+' ¬∑ Day '+loan.originDay+' ‚Üí '+(loan.originDay+loan.duration);
  el('rm-details').innerHTML=`<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--muted2)">Principal</span><span>${fUSD(loan.amount)}</span></div><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--muted2)">Interest</span><span style="color:var(--orange)">${fUSD(o.interest)}</span></div><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--muted2)">Total due</span><span style="font-weight:700">${fUSD(o.total)}</span></div><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--muted2)">Your cash</span><span style="color:${(myWallet.cash||0)>=o.total?'var(--green)':'var(--red)'}">${fUSD(myWallet.cash||0)}</span></div><div style="display:flex;justify-content:space-between"><span style="color:var(--muted2)">Collateral returned</span><span style="color:var(--green)">${fBTC(loan.collateralBtc)}</span></div>`;
  el('repay-modal').style.display='flex';
}
function closeRepayModal(){el('repay-modal').style.display='none';}
async function confirmRepay(){
  const loan=loansData[repayLoanId];if(!loan)return;
  const day=gameData.day||0, o=owed(loan,day);
  const bSnap=await db.ref(`rooms/${roomCode}/wallets/${myId}`).once('value');const bw=bSnap.val()||{};
  if((bw.cash||0)<o.total){alert('Need '+fUSD(o.total)+', have '+fUSD(bw.cash||0));return;}
  const lSnap=await db.ref(`rooms/${roomCode}/wallets/${loan.lenderId}`).once('value');const lw=lSnap.val()||{};
  const newLSD=Math.min((bw.loansSinceDefault||0)+1,(gameSettings.tau||2)+10);
  const stillInPunishment=bw.inPunishment&&newLSD<(gameSettings.tau||2);
  await db.ref().update({
    [`rooms/${roomCode}/loans/${repayLoanId}/status`]:'repaid',
    [`rooms/${roomCode}/wallets/${myId}/cash`]:(bw.cash||0)-o.total,
    [`rooms/${roomCode}/wallets/${myId}/btc`]:(bw.btc||0)+loan.collateralBtc,
    [`rooms/${roomCode}/wallets/${myId}/repaid`]:(bw.repaid||0)+1,
    [`rooms/${roomCode}/wallets/${myId}/loansSinceDefault`]:newLSD,
    [`rooms/${roomCode}/wallets/${myId}/inPunishment`]:stillInPunishment,
    [`rooms/${roomCode}/wallets/${loan.lenderId}/cash`]:(lw.cash||0)+o.total,
    [`rooms/${roomCode}/wallets/${loan.lenderId}/totalInterest`]:(lw.totalInterest||0)+o.interest,
    [`rooms/${roomCode}/wallets/${loan.lenderId}/repaid`]:(lw.repaid||0)+1,
    [`rooms/${roomCode}/game/totalRepaid`]:(gameData.totalRepaid||0)+1,
  });
  const tau=gameSettings.tau||2;
  addLog(`${myName} repaid ${fUSD(o.total)} to ${loan.lenderName} (œÑ ${newLSD}/${tau}${newLSD>=tau&&!stillInPunishment?' ‚Äî credit unlocked!':''})`,'up');
  closeRepayModal();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BTC TRADING (single player implementation)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setTradeSide(who,side){
  playerTradeSide=side;
  el('p-trade-buy').classList.toggle('active',side==='buy');
  el('p-trade-sell').classList.toggle('active',side==='sell');
  renderPlayerTradePcts();
  updateTradePreview('player');
}
function makePctButtons(values,inputId,previewWho){
  return [0,1,2,3].map(function(i){
    var pct=[0.25,0.5,0.75,1][i], v=values[i];
    return '<button class="btn btn-surface btn-xs" style="flex:1" onclick="el(\''+inputId+'\').value=\''+v+'\';updateTradePreview(\''+previewWho+'\')">'+(pct*100)+'%</button>';
  }).join('');
}
function renderPlayerTradePcts(){
  const price=gameData.price||65000, w=myWallet;
  var vals;
  if(playerTradeSide==='buy'){const maxBuy=(w.cash||0)/price;vals=[0.25,0.5,0.75,1].map(function(p){return (maxBuy*p).toFixed(4);});}
  else{vals=[0.25,0.5,0.75,1].map(function(p){return ((w.btc||0)*p).toFixed(4);});}
  if(el('p-trade-pcts')) el('p-trade-pcts').innerHTML=makePctButtons(vals,'p-trade-amt','player');
}
function updateTradePreview(who){
  const side=playerTradeSide;
  const amtEl=el('p-trade-amt');
  const prevEl=el('p-trade-preview');
  if(!amtEl||!prevEl)return;
  const amt=parseFloat(amtEl.value);const price=gameData.price||65000;
  if(!amt||amt<=0){prevEl.style.display='none';return;}
  const w=myWallet;
  if(side==='buy'){const cost=amt*price;const canDo=(w.cash||0)>=cost;prevEl.style.display='';prevEl.innerHTML=`<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--muted2)">Cost</span><span style="color:${canDo?'var(--text)':'var(--red)'}">${fUSD(cost)}</span></div><div style="display:flex;justify-content:space-between"><span style="color:var(--muted2)">Cash after</span><span>${fUSD((w.cash||0)-cost)}</span></div>${!canDo?'<div style="color:var(--red);margin-top:4px;font-size:10px">Insufficient cash</div>':''}`;}
  else{const proceeds=amt*price;const canDo=(w.btc||0)>=amt;prevEl.style.display='';prevEl.innerHTML=`<div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="color:var(--muted2)">Proceeds</span><span>${fUSD(proceeds)}</span></div><div style="display:flex;justify-content:space-between"><span style="color:var(--muted2)">BTC after</span><span>${fBTC((w.btc||0)-amt)}</span></div>${!canDo?'<div style="color:var(--red);margin-top:4px;font-size:10px">Insufficient BTC</div>':''}`;}
}
async function executeTrade(who){
  const side=playerTradeSide;
  const amtEl=el('p-trade-amt');
  const amt=parseFloat(amtEl.value);
  if(!amt||amt<=0){alert('Enter an amount.');return;}
  const price=gameData.price||65000;
  const wSnap=await db.ref(`rooms/${roomCode}/wallets/${myId}`).once('value');const w=wSnap.val()||{};
  const updates={};
  if(side==='buy'){
    const cost=amt*price;
    if((w.cash||0)<cost){alert('Need '+fUSD(cost)+', have '+fUSD(w.cash||0));return;}
    updates[`rooms/${roomCode}/wallets/${myId}/cash`]=(w.cash||0)-cost;
    updates[`rooms/${roomCode}/wallets/${myId}/btc`]=(w.btc||0)+amt;
    addLog(`${myName} bought ${fBTC(amt)} @ ${fUSD(price)}`,'gold');
  } else {
    if((w.btc||0)<amt){alert('Only have '+fBTC(w.btc||0));return;}
    const proceeds=amt*price;
    updates[`rooms/${roomCode}/wallets/${myId}/btc`]=(w.btc||0)-amt;
    updates[`rooms/${roomCode}/wallets/${myId}/cash`]=(w.cash||0)+proceeds;
    addLog(`${myName} sold ${fBTC(amt)} @ ${fUSD(price)}`,'info');
  }
  const gSnap=await db.ref(`rooms/${roomCode}/game`).once('value');const g=gSnap.val()||{};
  updates[`rooms/${roomCode}/game/totalBtcTraded`]=(g.totalBtcTraded||0)+amt;
  updates[`rooms/${roomCode}/game/totalTradeVol`]=(g.totalTradeVol||0)+amt*price;
  await db.ref().update(updates);
  amtEl.value='';
  el('p-trade-preview').style.display='none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHART + LOG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawChart(canvasId,data,w,h){
  const canvas=el(canvasId);if(!canvas||data.length<2)return;
  const ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,w,h);
  const mn=Math.min(...data),mx=Math.max(...data),r=mx-mn||1;
  const pts=data.map((v,i)=>[i/(data.length-1)*w,h-((v-mn)/r)*(h-4)-2]);
  const last=data[data.length-1],prev=data[data.length-2];
  const color=last>=prev?'#00d68f':'#ff3b5c';
  ctx.beginPath();ctx.strokeStyle=color;ctx.lineWidth=1.5;ctx.lineJoin='round';
  pts.forEach(([x,y],i)=>i===0?ctx.moveTo(x,y):ctx.lineTo(x,y));ctx.stroke();
  const grad=ctx.createLinearGradient(0,0,0,h);
  grad.addColorStop(0,last>=prev?'rgba(0,214,143,.15)':'rgba(255,59,92,.15)');grad.addColorStop(1,'transparent');
  ctx.lineTo(w,h);ctx.lineTo(0,h);ctx.closePath();ctx.fillStyle=grad;ctx.fill();
}
async function addLog(msg,type='info'){
  const day=gameData.day||0;
  const logRef=db.ref(`rooms/${roomCode}/game/log`);
  const snap=await logRef.once('value');const log=snap.val()||[];
  await logRef.set([...log.slice(-80),{day,msg,type}]);
}
// Make el globally accessible for inline handlers
window.el=el;
</script>
</body>
</html>
